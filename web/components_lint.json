[{"filePath":"D:\\code\\witweb\\web\\src\\components\\Icons.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\LegacyLayout.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":77,"column":23,"nodeType":"JSXOpeningElement","endLine":81,"endColumn":25},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":99,"column":29,"nodeType":"JSXOpeningElement","endLine":102,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿\"use client\";\r\n\r\nimport { useEffect, useRef, useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { usePathname, useRouter } from \"next/navigation\";\r\nimport { useAuth } from \"@/app/providers\";\r\nimport { getThumbnailUrl } from \"@/utils/url\";\r\n\r\nconst adminUsername = process.env.NEXT_PUBLIC_ADMIN_USERNAME || \"witw\";\r\n\r\nexport default function LegacyLayout({ children }: { children: React.ReactNode }) {\r\n  const { user, logout, isAuthenticated } = useAuth();\r\n  const router = useRouter();\r\n  const pathname = usePathname();\r\n  const [showUserMenu, setShowUserMenu] = useState(false);\r\n  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);\r\n  const userMenuRef = useRef<HTMLDivElement | null>(null);\r\n  const isStudio = pathname.startsWith(\"/studio\");\r\n\r\n  const toggleMobileMenu = () => setIsMobileMenuOpen(!isMobileMenuOpen);\r\n  const closeMobileMenu = () => setIsMobileMenuOpen(false);\r\n\r\n  const handleLogout = () => {\r\n    logout();\r\n    router.push(\"/login\");\r\n    setShowUserMenu(false);\r\n  };\r\n\r\n  useEffect(() => {\r\n    function handleOutsideClick(event: MouseEvent) {\r\n      if (!showUserMenu) return;\r\n      if (userMenuRef.current && !userMenuRef.current.contains(event.target as Node)) {\r\n        setShowUserMenu(false);\r\n      }\r\n    }\r\n    document.addEventListener(\"mousedown\", handleOutsideClick);\r\n    return () => document.removeEventListener(\"mousedown\", handleOutsideClick);\r\n  }, [showUserMenu]);\r\n\r\n  const navClass = (path: string) =>\r\n    pathname === path || (path === \"/studio\" && isStudio)\r\n      ? \"nav-link active\"\r\n      : \"nav-link\";\r\n\r\n  return (\r\n    <div className=\"layout\">\r\n      <header className=\"header\">\r\n        <div className=\"container header-content\">\r\n          <Link href=\"/\" className=\"brand\">witweb</Link>\r\n\r\n          <button className=\"mobile-menu-toggle\" onClick={toggleMobileMenu} aria-label=\"Toggle navigation\">\r\n            <span className={`hamburger ${isMobileMenuOpen ? \"active\" : \"\"}`}></span>\r\n          </button>\r\n\r\n          <nav className={`nav ${isMobileMenuOpen ? \"mobile-open\" : \"\"}`}>\r\n            <Link href=\"/\" className={navClass(\"/\")} onClick={closeMobileMenu}>首页</Link>\r\n            <Link href=\"/forum\" className={navClass(\"/forum\")} onClick={closeMobileMenu}>论坛</Link>\r\n            {isAuthenticated && user?.username === adminUsername && (\r\n              <Link href=\"/admin\" className=\"nav-link\" onClick={closeMobileMenu}>管理后台</Link>\r\n            )}\r\n            <Link href=\"/studio\" className={navClass(\"/studio\")} onClick={closeMobileMenu}>工作台</Link>\r\n          </nav>\r\n\r\n          {isMobileMenuOpen && (\r\n            <div className=\"mobile-menu-overlay\" onClick={closeMobileMenu}></div>\r\n          )}\r\n\r\n          <div className=\"actions\">\r\n            {isAuthenticated ? (\r\n              <>\r\n                <Link href=\"/publish\" className=\"btn-primary nav-publish-button\">\r\n                  {\"\\u53d1\\u5e03\\u6587\\u7ae0\"}\r\n                </Link>\r\n                <div className=\"user-menu-container\" ref={userMenuRef}>\r\n                  <button className=\"user-button\" onClick={() => setShowUserMenu(!showUserMenu)}>\r\n                    {user?.avatar_url ? (\r\n                      <img\r\n                        src={getThumbnailUrl(user.avatar_url, 64)}\r\n                        alt={user.nickname || user.username}\r\n                        className=\"user-avatar\"\r\n                      />\r\n                    ) : (\r\n                      <div className=\"user-avatar-fallback\">\r\n                        {(user?.nickname || user?.username)?.[0]?.toUpperCase()}\r\n                      </div>\r\n                    )}\r\n                    <span className=\"user-name\">{user?.nickname || user?.username}</span>\r\n                    <svg className=\"dropdown-icon\" width=\"12\" height=\"12\" viewBox=\"0 0 12 12\" fill=\"currentColor\">\r\n                      <path d=\"M6 8L2 4h8L6 8z\" />\r\n                    </svg>\r\n                  </button>\r\n\r\n                  {showUserMenu && (\r\n                    <div className=\"user-dropdown-card\">\r\n                      <div className=\"user-dropdown-cover\"></div>\r\n                      <div className=\"user-dropdown-body\">\r\n                        <div className=\"user-dropdown-avatar\">\r\n                          {user?.avatar_url ? (\r\n                            <img\r\n                              src={getThumbnailUrl(user.avatar_url, 96)}\r\n                              alt={user.nickname || user.username}\r\n                            />\r\n                          ) : (\r\n                            <div className=\"user-dropdown-avatar-fallback\">\r\n                              {(user?.nickname || user?.username)?.[0]?.toUpperCase()}\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                        <div className=\"user-dropdown-name\">{user?.nickname || user?.username}</div>\r\n                        <div className=\"user-dropdown-handle\">@{user?.username || \"user\"}</div>\r\n                        <div className=\"user-dropdown-stats\">\r\n                          <div className=\"user-stat\">\r\n                            <div className=\"user-stat-value\">{user?.following_count ?? 0}</div>\r\n                            <div className=\"user-stat-label\">{\"关注\"}</div>\r\n                          </div>\r\n                          <div className=\"user-stat\">\r\n                            <div className=\"user-stat-value\">{user?.follower_count ?? 0}</div>\r\n                            <div className=\"user-stat-label\">{\"粉丝\"}</div>\r\n                          </div>\r\n                          <div className=\"user-stat\">\r\n                            <div className=\"user-stat-value\">{user?.post_count ?? 0}</div>\r\n                            <div className=\"user-stat-label\">{\"动态\"}</div>\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"user-dropdown-links\">\r\n                          <Link href=\"/profile\" className=\"dropdown-item\" onClick={() => setShowUserMenu(false)}>\r\n                            {\"\\u4e2a\\u4eba\\u4e2d\\u5fc3\"}\r\n                          </Link>\r\n                          <Link href=\"/favorites\" className=\"dropdown-item\" onClick={() => setShowUserMenu(false)}>\r\n                            {\"\\u6211\\u7684\\u6536\\u85cf\"}\r\n                          </Link>\r\n                          <button onClick={handleLogout} className=\"dropdown-item danger\">{\"\\u9000\\u51fa\\u767b\\u5f55\"}</button>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </>\r\n            ) : (\r\n              <div className=\"auth-buttons\">\r\n                <Link href=\"/login\" className=\"btn-ghost\">{\"登录\"}</Link>\r\n                <Link href=\"/register\" className=\"btn-primary\">{\"注册\"}</Link>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      <main className={`main-content ${isStudio ? \"full-width\" : \"container\"}`}>\r\n        {children}\r\n      </main>\r\n\r\n      <footer className=\"footer\">\r\n        <div className=\"container\">\r\n          <p>© {new Date().getFullYear()} witweb. 基于 Next.js 构建</p>\r\n        </div>\r\n      </footer>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\RequireAuth.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\TopNav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\BlogListPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'clearCommentsCache' is defined but never used.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"clearCommentsCache"},"fix":{"range":[383,402],"text":""},"desc":"Remove unused variable \"clearCommentsCache\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'clearPostCache' is defined but never used.","line":13,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":17,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"clearPostCache"},"fix":{"range":[420,439],"text":""},"desc":"Remove unused variable \"clearPostCache\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'userPostCount' is assigned a value but never used.","line":40,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdmin' is assigned a value but never used.","line":45,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":16},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\code\\witweb\\web\\src\\components\\legacy\\BlogListPage.tsx:57:7\n  55 |     if (typeof window === 'undefined') return;\n  56 |     try {\n> 57 |       setTokenValue(localStorage.getItem(\"token\"));\n     |       ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  58 |       const storedProfile = localStorage.getItem(\"profile\");\n  59 |       const parsedProfile = storedProfile ? JSON.parse(storedProfile) : null;\n  60 |       setProfileData(parsedProfile);","line":57,"column":7,"nodeType":null,"endLine":57,"endColumn":20},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\code\\witweb\\web\\src\\components\\legacy\\BlogListPage.tsx:139:7\n  137 |   useEffect(() => {\n  138 |     if (!profileData?.username) {\n> 139 |       setUserPostCount(0);\n      |       ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  140 |       return;\n  141 |     }\n  142 |     const params = new URLSearchParams({","line":139,"column":7,"nodeType":null,"endLine":139,"endColumn":23},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadPosts'. Either include it or remove the dependency array.","line":253,"column":6,"nodeType":"ArrayExpression","endLine":253,"endColumn":60,"suggestions":[{"desc":"Update the dependencies array to be: [currentPage, submittedQuery, authorFilter, tagFilter, loadPosts]","fix":{"range":[8766,8820],"text":"[currentPage, submittedQuery, authorFilter, tagFilter, loadPosts]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'applyProfileUpdate'. Either include it or remove the dependency array.","line":272,"column":6,"nodeType":"ArrayExpression","endLine":272,"endColumn":85,"suggestions":[{"desc":"Update the dependencies array to be: [currentPage, submittedQuery, authorFilter, tagFilter, tokenValue, profileData, applyProfileUpdate]","fix":{"range":[9516,9595],"text":"[currentPage, submittedQuery, authorFilter, tagFilter, tokenValue, profileData, applyProfileUpdate]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadPosts'. Either include it or remove the dependency array.","line":276,"column":6,"nodeType":"ArrayExpression","endLine":276,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadPosts]","fix":{"range":[9667,9669],"text":"[loadPosts]"}}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\code\\witweb\\web\\src\\components\\legacy\\BlogListPage.tsx:286:9\n  284 |         const storedProfile = localStorage.getItem(\"profile\");\n  285 |         const parsedProfile = storedProfile ? JSON.parse(storedProfile) : null;\n> 286 |         applyProfileUpdate(parsedProfile);\n      |         ^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  287 |       } catch {\n  288 |         applyProfileUpdate(null);\n  289 |       }","line":286,"column":9,"nodeType":null,"endLine":286,"endColumn":27},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'applyProfileUpdate'. Either include it or remove the dependency array.","line":291,"column":6,"nodeType":"ArrayExpression","endLine":291,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [applyProfileUpdate]","fix":{"range":[10167,10169],"text":"[applyProfileUpdate]"}}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\code\\witweb\\web\\src\\components\\legacy\\BlogListPage.tsx:294:5\n  292 |\n  293 |   useEffect(() => {\n> 294 |     setCurrentPage(1);\n      |     ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  295 |   }, [submittedQuery, authorFilter, tagFilter]);\n  296 |\n  297 |   async function publish() {","line":294,"column":5,"nodeType":null,"endLine":294,"endColumn":19},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":478,"column":25,"nodeType":"JSXOpeningElement","endLine":486,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'thumbnailUrl' is assigned a value but never used.","line":667,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":667,"endColumn":33},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":679,"column":25,"nodeType":"JSXOpeningElement","endLine":685,"endColumn":27}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿\r\n\"use client\";\r\n\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { getThumbnailUrl } from \"@/utils/url\";\r\nimport { ThumbsUpIcon, ThumbsDownIcon, BookmarkIcon, MessageCircleIcon } from \"@/components/Icons\";\r\nimport { getCachedJson, setCachedJson } from \"@/utils/cache\";\r\nimport {\r\n  clearCommentsCache,\r\n  clearListCache,\r\n  clearPostCache,\r\n  clearAllCaches,\r\n  getListCache,\r\n  setListCache as setListCacheMemory,\r\n} from \"@/utils/memoryStore\";\r\nimport { resizeImageFile } from \"@/utils/image\";\r\n\r\nexport default function BlogListPage() {\r\n  const [posts, setPosts] = useState<any[]>([]);\r\n  const [submittedQuery, setSubmittedQuery] = useState(\"\");\r\n  const normalizedQuery = submittedQuery.trim().toLowerCase();\r\n  const [tagFilter, setTagFilter] = useState(\"\");\r\n  const [searchInput, setSearchInput] = useState(\"\");\r\n  const [showSuggestions, setShowSuggestions] = useState(false);\r\n  const [currentPage, setCurrentPage] = useState(1);\r\n  const pageSize = 5;\r\n  const [title, setTitle] = useState(\"\");\r\n  const [tags, setTags] = useState(\"\");\r\n  const [content, setContent] = useState(\"\");\r\n  const [publishStatus, setPublishStatus] = useState(\"\");\r\n  const [imageWidth, setImageWidth] = useState(\"\");\r\n  const [imageSizePercent, setImageSizePercent] = useState(100);\r\n  const [showSizeModal, setShowSizeModal] = useState(false);\r\n  const [pendingImageFile, setPendingImageFile] = useState<File | null>(null);\r\n  const [pendingPreviewUrl, setPendingPreviewUrl] = useState(\"\");\r\n  const [profileData, setProfileData] = useState<any>(null);\r\n  const [tokenValue, setTokenValue] = useState<string | null>(null);\r\n  const [userPostCount, setUserPostCount] = useState(0);\r\n  const router = useRouter();\r\n  const contentRef = useRef<HTMLTextAreaElement | null>(null);\r\n  const searchRef = useRef<HTMLInputElement | null>(null);\r\n  const [status, setStatus] = useState(\"loading\");\r\n  const isAdmin = profileData?.username === \"witw\";\r\n  const [authorFilter, setAuthorFilter] = useState(\"\");\r\n  const [totalCount, setTotalCount] = useState(0);\r\n  const etagRef = useRef(\"\");\r\n  const listCacheKeyRef = useRef(\"\");\r\n  const listFallbackCacheKeyRef = useRef(\"\");\r\n  const totalCountRef = useRef(0);\r\n  const profileUpdateRef = useRef<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return;\r\n    try {\r\n      setTokenValue(localStorage.getItem(\"token\"));\r\n      const storedProfile = localStorage.getItem(\"profile\");\r\n      const parsedProfile = storedProfile ? JSON.parse(storedProfile) : null;\r\n      setProfileData(parsedProfile);\r\n      if (parsedProfile?.username) {\r\n        setCachedJson(`cache:profile:${parsedProfile.username}`, parsedProfile);\r\n      }\r\n    } catch {\r\n      setProfileData(null);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    totalCountRef.current = totalCount;\r\n  }, [totalCount]);\r\n\r\n\r\n  function applyProfileUpdate(nextProfile: any) {\r\n    if (nextProfile) {\r\n      setProfileData(nextProfile);\r\n      if (nextProfile?.username) {\r\n        setCachedJson(`cache:profile:${nextProfile.username}`, nextProfile);\r\n      }\r\n      if (nextProfile?.username) {\r\n        const nextName = nextProfile.nickname || nextProfile.username;\r\n        setPosts((prev) =>\r\n          prev.map((post) =>\r\n            post.author === nextProfile.username\r\n              ? { ...post, author_avatar: nextProfile.avatar_url || \"\", author_name: nextName }\r\n              : post\r\n          )\r\n        );\r\n      }\r\n    }\r\n    clearAllCaches();\r\n    try {\r\n      Object.keys(localStorage).forEach((key) => {\r\n        if (key.startsWith(\"cache:blog:\") || key.startsWith(\"cache:post:\") || key.startsWith(\"cache:comments:\") || key.startsWith(\"cache:favorites:\") || key.startsWith(\"cache:profile:\")) {\r\n          localStorage.removeItem(key);\r\n        }\r\n      });\r\n    } catch {}\r\n    loadPosts({ showLoading: false, force: true });\r\n  }\r\n  function normalizeListPayload(data: any) {\r\n    if (Array.isArray(data)) {\r\n      return { items: data, total: data.length };\r\n    }\r\n    return {\r\n      items: Array.isArray(data?.items) ? data.items : [],\r\n      total: data?.total || 0,\r\n    };\r\n  }\r\n\r\n  function buildListCacheKey(params: URLSearchParams, username: string) {\r\n    return `cache:blog:${username}:${params.toString()}`;\r\n  }\r\n\r\n  function setListCache(value: any) {\r\n    if (listCacheKeyRef.current) {\r\n      setCachedJson(listCacheKeyRef.current, value);\r\n      setListCacheMemory(listCacheKeyRef.current, value);\r\n    }\r\n    if (listFallbackCacheKeyRef.current && listFallbackCacheKeyRef.current !== listCacheKeyRef.current) {\r\n      setCachedJson(listFallbackCacheKeyRef.current, value);\r\n      setListCacheMemory(listFallbackCacheKeyRef.current, value);\r\n    }\r\n  }\r\n\r\n  function applyPostUpdates(updater: (prev: any[]) => any[]) {\r\n    setPosts((prev) => {\r\n      const next = updater(prev);\r\n      setListCache({\r\n        items: next,\r\n        total: totalCountRef.current,\r\n      });\r\n      return next;\r\n    });\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (!profileData?.username) {\r\n      setUserPostCount(0);\r\n      return;\r\n    }\r\n    const params = new URLSearchParams({\r\n      author: profileData.username,\r\n      page: \"1\",\r\n      size: \"1\",\r\n    });\r\n    const cacheKey = buildListCacheKey(params, profileData.username);\r\n    const cached = getCachedJson(cacheKey);\r\n    if (cached && typeof (cached as any).total === \"number\") {\r\n      setUserPostCount((cached as any).total);\r\n      return;\r\n    }\r\n    fetch(`/api/blog?${params.toString()}`)\r\n      .then((res) => res.json())\r\n      .then((data) => {\r\n        const normalized = normalizeListPayload(data);\r\n        if (typeof normalized.total === \"number\") {\r\n          setUserPostCount(normalized.total);\r\n          setCachedJson(cacheKey, normalized);\r\n        }\r\n      })\r\n      .catch(() => {\r\n        setUserPostCount(0);\r\n      });\r\n  }, [profileData]);\r\n\r\n  useEffect(() => {\r\n    function handleClickOutside(event: MouseEvent) {\r\n      if (searchRef.current && !searchRef.current.contains(event.target as Node)) {\r\n        setShowSuggestions(false);\r\n      }\r\n    }\r\n    if (showSuggestions) {\r\n      document.addEventListener(\"mousedown\", handleClickOutside);\r\n    }\r\n    return () => {\r\n      document.removeEventListener(\"mousedown\", handleClickOutside);\r\n    };\r\n  }, [showSuggestions]);\r\n\r\n  function loadPosts(options: { showLoading?: boolean; force?: boolean } = {}) {\r\n    const { showLoading = false, force = false } = options;\r\n    const params = new URLSearchParams({\r\n      page: String(currentPage),\r\n      size: String(pageSize),\r\n    });\r\n    if (submittedQuery.trim()) {\r\n      params.set(\"q\", submittedQuery.trim());\r\n    }\r\n    if (authorFilter) {\r\n      params.set(\"author\", authorFilter);\r\n    }\r\n    if (tagFilter.trim()) {\r\n      params.set(\"tag\", tagFilter.trim());\r\n    }\r\n    const username = profileData?.username || \"anon\";\r\n    const cacheKey = buildListCacheKey(params, username);\r\n    const fallbackKey = buildListCacheKey(params, \"anon\");\r\n    listCacheKeyRef.current = cacheKey;\r\n    listFallbackCacheKeyRef.current = fallbackKey;\r\n    if (!force) {\r\n      const cachedMemory =\r\n        getListCache(cacheKey) || (cacheKey !== fallbackKey ? getListCache(fallbackKey) : null);\r\n      const cached =\r\n        cachedMemory ||\r\n        getCachedJson(cacheKey) ||\r\n        (cacheKey !== fallbackKey ? getCachedJson(fallbackKey) : null);\r\n      if (cached) {\r\n        const normalized = normalizeListPayload(cached);\r\n        setPosts(normalized.items);\r\n        setTotalCount(normalized.total);\r\n        setStatus(\"ready\");\r\n        return;\r\n      }\r\n    }\r\n    if (showLoading) {\r\n      setStatus(\"loading\");\r\n    }\r\n    const token = tokenValue;\r\n    const headers: Record<string, string> = {\r\n      ...(etagRef.current ? { \"If-None-Match\": etagRef.current } : {}),\r\n      ...(token ? { Authorization: `Bearer ${token}` } : {}),\r\n    };\r\n    fetch(`/api/blog?${params.toString()}`, { headers })\r\n      .then(async (res) => {\r\n        if (res.status === 304) {\r\n          setStatus(\"ready\");\r\n          return null;\r\n        }\r\n        const nextEtag = res.headers.get(\"ETag\");\r\n        if (nextEtag) {\r\n          etagRef.current = nextEtag;\r\n        }\r\n        return res.json();\r\n      })\r\n      .then((data) => {\r\n        if (!data) return;\r\n        const normalized = normalizeListPayload(data);\r\n        setPosts(normalized.items);\r\n        setTotalCount(normalized.total);\r\n        setListCache(normalized);\r\n        setStatus(\"ready\");\r\n      })\r\n      .catch(() => {\r\n        if (showLoading) {\r\n          setStatus(\"error\");\r\n        }\r\n      });\r\n  }\r\n\r\n  useEffect(() => {\r\n    loadPosts({ showLoading: true });\r\n  }, [currentPage, submittedQuery, authorFilter, tagFilter]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    const handler = (event: Event) => {\r\n      const custom = event as CustomEvent;\r\n      if (custom?.detail) {\r\n        applyProfileUpdate(custom.detail);\r\n      } else {\r\n        try {\r\n          const storedProfile = localStorage.getItem(\"profile\");\r\n          const parsedProfile = storedProfile ? JSON.parse(storedProfile) : null;\r\n          setProfileData(parsedProfile);\r\n        } catch {}\r\n      }\r\n      applyProfileUpdate(null);\r\n    };\r\n    window.addEventListener(\"profile-updated\", handler as EventListener);\r\n    return () => window.removeEventListener(\"profile-updated\", handler as EventListener);\r\n  }, [currentPage, submittedQuery, authorFilter, tagFilter, tokenValue, profileData]);\r\n\r\n  useEffect(() => {\r\n    loadPosts({ showLoading: false });\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    const ts = localStorage.getItem(\"profile_updated_at\");\r\n    if (ts && profileUpdateRef.current !== ts) {\r\n      profileUpdateRef.current = ts;\r\n      try {\r\n        const storedProfile = localStorage.getItem(\"profile\");\r\n        const parsedProfile = storedProfile ? JSON.parse(storedProfile) : null;\r\n        applyProfileUpdate(parsedProfile);\r\n      } catch {\r\n        applyProfileUpdate(null);\r\n      }\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    setCurrentPage(1);\r\n  }, [submittedQuery, authorFilter, tagFilter]);\r\n\r\n  async function publish() {\r\n    setPublishStatus(\"\");\r\n    if (!title.trim() || !content.trim()) {\r\n      setPublishStatus(\"标题和内容不能为空。\");\r\n      return;\r\n    }\r\n    const token = tokenValue;\r\n    if (!token) {\r\n      router.push(\"/login\");\r\n      return;\r\n    }\r\n    const res = await fetch(\"/api/blog\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${token}`,\r\n      },\r\n      body: JSON.stringify({ title, content, tags }),\r\n    });\r\n    if (!res.ok) {\r\n      const data = await res.json().catch(() => ({}));\r\n      setPublishStatus(data.detail || \"发布失败。\");\r\n      return;\r\n    }\r\n    setPublishStatus(\"已发布。\");\r\n    setTitle(\"\");\r\n    setTags(\"\");\r\n    setContent(\"\");\r\n    if (listCacheKeyRef.current) {\r\n      clearListCache(listCacheKeyRef.current);\r\n    }\r\n    if (listFallbackCacheKeyRef.current) {\r\n      clearListCache(listFallbackCacheKeyRef.current);\r\n    }\r\n    loadPosts({ showLoading: false, force: true });\r\n  }\r\n\r\n  function handleImageSelect(file: File | undefined) {\r\n    if (!file) return;\r\n    if (pendingPreviewUrl) {\r\n      URL.revokeObjectURL(pendingPreviewUrl);\r\n    }\r\n    const preview = URL.createObjectURL(file);\r\n    setPendingImageFile(file);\r\n    setPendingPreviewUrl(preview);\r\n    setShowSizeModal(true);\r\n  }\r\n\r\n  async function uploadImage(file: File) {\r\n    const token = tokenValue;\r\n    if (!token) {\r\n      router.push(\"/login\");\r\n      return null;\r\n    }\r\n    const resized = await resizeImageFile(file, 1600);\r\n    const formData = new FormData();\r\n    formData.append(\"file\", resized);\r\n    const res = await fetch(\"/api/upload-image\", {\r\n      method: \"POST\",\r\n      headers: { Authorization: `Bearer ${token}` },\r\n      body: formData,\r\n    });\r\n    if (!res.ok) {\r\n      return null;\r\n    }\r\n    const data = await res.json();\r\n    return data.url || null;\r\n  }\r\n\r\n  function insertImageMarkup(url: string, widthValue: string) {\r\n    const markup = widthValue\r\n      ? `<img src=\"${url}\" style=\"max-width: 100%; width: ${widthValue};\" />`\r\n      : `![](${url})`;\r\n    const textarea = contentRef.current;\r\n    if (!textarea) {\r\n      setContent((prev) => `${prev}\\n\\n${markup}\\n`);\r\n      return;\r\n    }\r\n    const start = textarea.selectionStart || 0;\r\n    const end = textarea.selectionEnd || 0;\r\n    setContent((prev) => `${prev.slice(0, start)}${markup}${prev.slice(end)}`);\r\n    requestAnimationFrame(() => {\r\n      textarea.focus();\r\n      const cursor = start + markup.length;\r\n      textarea.setSelectionRange(cursor, cursor);\r\n    });\r\n  }\r\n\r\n  const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));\r\n  const tagSuggestions = useMemo(\r\n    () =>\r\n      Array.from(\r\n        new Set(\r\n          posts\r\n            .flatMap((post) => (post.tags || \"\").split(/[,，]/))\r\n            .map((tag) => tag.trim())\r\n            .filter(Boolean),\r\n        ),\r\n      ),\r\n    [posts],\r\n  );\r\n  const titleSuggestions = useMemo(\r\n    () => Array.from(new Set(posts.map((post) => post.title).filter(Boolean))),\r\n    [posts],\r\n  );\r\n  const normalizedInput = searchInput.trim().toLowerCase();\r\n  const filteredTags = normalizedInput\r\n    ? tagSuggestions.filter((tag) => tag.toLowerCase().includes(normalizedInput))\r\n    : [];\r\n  const filteredTitles = normalizedInput\r\n    ? titleSuggestions.filter((titleText) => titleText.toLowerCase().includes(normalizedInput))\r\n    : [];\r\n  return (\r\n    <div className=\"blog-list-page\" style={{ minHeight: \"calc(100vh - 60px)\", paddingTop: \"2rem\", paddingBottom: \"64px\" }}>\r\n      <div className=\"split-layout\">\r\n        <aside className=\"side-panel\">\r\n          <div className=\"card\">\r\n            <h3 className=\"text-lg font-bold mb-4\">发布新文章</h3>\r\n            {!tokenValue ? (\r\n              <>\r\n                <p className=\"text-muted mb-4 text-sm\">登录后可在此发布文章。</p>\r\n                <Link className=\"btn-primary w-full\" href=\"/login\">\r\n                  去登录\r\n                </Link>\r\n              </>\r\n            ) : (\r\n              <div className=\"flex flex-col gap-4\">\r\n                <div>\r\n                  <label className=\"text-sm font-medium mb-1 block\">标题</label>\r\n                  <input\r\n                    className=\"input\"\r\n                    value={title}\r\n                    onChange={(event) => setTitle(event.target.value)}\r\n                    placeholder=\"文章标题\"\r\n                  />\r\n                </div>\r\n                <div>\r\n                  <label className=\"text-sm font-medium mb-1 block\">标签</label>\r\n                  <input\r\n                    className=\"input\"\r\n                    value={tags}\r\n                    onChange={(event) => setTags(event.target.value)}\r\n                    placeholder=\"例如：动画, 角色, 经验\"\r\n                  />\r\n                </div>\r\n                <div>\r\n                  <div className=\"flex justify-between items-center mb-1\">\r\n                    <label className=\"text-sm font-medium block\">内容</label>\r\n                    <label className=\"btn-ghost btn-sm cursor-pointer\">\r\n                      上传图片\r\n                      <input\r\n                        type=\"file\"\r\n                        accept=\"image/*\"\r\n                        className=\"hidden\"\r\n                        style={{ display: \"none\" }}\r\n                        onChange={(event) => {\r\n                          const file = event.target.files?.[0];\r\n                          handleImageSelect(file);\r\n                          event.target.value = \"\";\r\n                        }}\r\n                      />\r\n                    </label>\r\n                  </div>\r\n                  <textarea\r\n                    className=\"input\"\r\n                    rows={12}\r\n                    value={content}\r\n                    onChange={(event) => setContent(event.target.value)}\r\n                    ref={contentRef}\r\n                    placeholder=\"使用 Markdown 写作...\"\r\n                  />\r\n                </div>\r\n\r\n                {showSizeModal && pendingImageFile && (\r\n                  <div\r\n                    className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\"\r\n                    style={{ background: \"rgba(0,0,0,0.8)\", position: \"fixed\", top: 0, left: 0, right: 0, bottom: 0, display: \"flex\", alignItems: \"center\", justifyContent: \"center\" }}\r\n                  >\r\n                    <div className=\"card\" style={{ width: \"400px\", maxWidth: \"90%\" }}>\r\n                      <h3 className=\"text-lg font-bold mb-4\">调整图片大小</h3>\r\n                      <div className=\"mb-4 bg-black/20 p-2 rounded flex justify-center\">\r\n                        <img\r\n                          src={pendingPreviewUrl}\r\n                          alt=\"preview\"\r\n                          style={{\r\n                            maxWidth: \"100%\",\r\n                            maxHeight: \"300px\",\r\n                            width: imageWidth.trim() ? imageWidth.trim() : `${imageSizePercent}%`,\r\n                          }}\r\n                        />\r\n                      </div>\r\n                      <div className=\"flex items-center gap-2 mb-4\">\r\n                        <input\r\n                          type=\"range\"\r\n                          min=\"10\"\r\n                          max=\"100\"\r\n                          className=\"flex-1\"\r\n                          value={imageSizePercent}\r\n                          onChange={(event) => setImageSizePercent(Number(event.target.value))}\r\n                        />\r\n                        <span className=\"text-sm w-12 text-right\">{imageSizePercent}%</span>\r\n                      </div>\r\n                      <input\r\n                        className=\"input mb-4\"\r\n                        value={imageWidth}\r\n                        onChange={(event) => setImageWidth(event.target.value)}\r\n                        placeholder=\"或输入宽度，例如 360px / 60%\"\r\n                      />\r\n                      <div className=\"flex gap-2 justify-end\">\r\n                        <button\r\n                          className=\"btn-ghost\"\r\n                          type=\"button\"\r\n                          onClick={() => {\r\n                            if (pendingPreviewUrl) URL.revokeObjectURL(pendingPreviewUrl);\r\n                            setPendingPreviewUrl(\"\");\r\n                            setPendingImageFile(null);\r\n                            setShowSizeModal(false);\r\n                          }}\r\n                        >\r\n                          取消\r\n                        </button>\r\n                        <button\r\n                          className=\"btn-primary\"\r\n                          type=\"button\"\r\n                          onClick={async () => {\r\n                            const widthValue = imageWidth.trim() ? imageWidth.trim() : `${imageSizePercent}%`;\r\n                            if (!pendingImageFile) return;\r\n                            const url = await uploadImage(pendingImageFile);\r\n                            if (url) {\r\n                              insertImageMarkup(url, widthValue);\r\n                            }\r\n                            if (pendingPreviewUrl) URL.revokeObjectURL(pendingPreviewUrl);\r\n                            setPendingPreviewUrl(\"\");\r\n                            setPendingImageFile(null);\r\n                            setShowSizeModal(false);\r\n                          }}\r\n                        >\r\n                          插入图片\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                {publishStatus && <p className=\"text-accent text-sm\">{publishStatus}</p>}\r\n                <button className=\"btn-primary w-full\" type=\"button\" onClick={publish}>\r\n                  发布\r\n                </button>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </aside>\r\n\r\n        <section>\r\n          {status === \"error\" && <p>加载失败，请稍后再试。</p>}\r\n          {status === \"ready\" && posts.length === 0 && <p>暂无文章，去左侧发布第一篇吧。</p>}\r\n\r\n          <div className=\"section-header flex justify-between items-center mb-4\">\r\n            <h3 className=\"text-xl font-bold\">最新文章</h3>\r\n            <div className=\"search flex gap-2 items-center relative\" style={{ width: \"60%\" }}>\r\n              <input\r\n                className=\"input\"\r\n                ref={searchRef}\r\n                value={searchInput}\r\n                onChange={(event) => {\r\n                  setSearchInput(event.target.value);\r\n                  setShowSuggestions(true);\r\n                }}\r\n                onFocus={() => setShowSuggestions(true)}\r\n                onKeyDown={(event) => {\r\n                  if (event.key === \"Enter\") {\r\n                    setSubmittedQuery(searchInput);\r\n                    setTagFilter(searchInput);\r\n                    setShowSuggestions(false);\r\n                  }\r\n                }}\r\n                placeholder=\"搜索标题或标签...\"\r\n              />\r\n              {showSuggestions && (filteredTags.length > 0 || filteredTitles.length > 0) && (\r\n                <div className=\"search-suggestions\" onMouseDown={(event) => event.preventDefault()}>\r\n                  {filteredTags.length > 0 && (\r\n                    <>\r\n                      <div className=\"suggestion-group\">标签</div>\r\n                      {filteredTags.map((tag) => (\r\n                        <button\r\n                          key={`tag-${tag}`}\r\n                          className=\"suggestion-item\"\r\n                          type=\"button\"\r\n                          onClick={() => {\r\n                            setTagFilter(tag);\r\n                            setSubmittedQuery(\"\");\r\n                            setSearchInput(tag);\r\n                            setShowSuggestions(false);\r\n                          }}\r\n                        >\r\n                          #{tag}\r\n                        </button>\r\n                      ))}\r\n                    </>\r\n                  )}\r\n                  {filteredTitles.length > 0 && (\r\n                    <>\r\n                      <div className=\"suggestion-group\">文章</div>\r\n                      {filteredTitles.map((titleText) => (\r\n                        <button\r\n                          key={`title-${titleText}`}\r\n                          className=\"suggestion-item\"\r\n                          type=\"button\"\r\n                          onClick={() => {\r\n                            setSubmittedQuery(titleText);\r\n                            setTagFilter(\"\");\r\n                            setSearchInput(titleText);\r\n                            setShowSuggestions(false);\r\n                          }}\r\n                        >\r\n                          {titleText}\r\n                        </button>\r\n                      ))}\r\n                    </>\r\n                  )}\r\n                </div>\r\n              )}\r\n              {submittedQuery && (\r\n                <button\r\n                  className=\"button ghost\"\r\n                  type=\"button\"\r\n                  onClick={() => {\r\n                    setSubmittedQuery(\"\");\r\n                    setSearchInput(\"\");\r\n                  }}\r\n                >\r\n                  清空\r\n                </button>\r\n              )}\r\n              {authorFilter && (\r\n                <button className=\"button ghost\" type=\"button\" onClick={() => setAuthorFilter(\"\")}\r\n                >\r\n                  仅看我的文章\r\n                </button>\r\n              )}\r\n              {tagFilter && (\r\n                <button\r\n                  className=\"button ghost\"\r\n                  type=\"button\"\r\n                  onClick={() => {\r\n                    setTagFilter(\"\");\r\n                    setSearchInput(\"\");\r\n                  }}\r\n                >\r\n                  清除标签\r\n                </button>\r\n              )}\r\n            </div>\r\n          </div>\r\n          <div className=\"list grid\">\r\n            {posts.map((post) => {\r\n              const titleText = post.title || \"\";\r\n              const rawPreview = (post.content || \"\").replace(/\\s+/g, \" \").trim();\r\n              const preview =\r\n                rawPreview.length > 0\r\n                  ? `${rawPreview.slice(0, 160)}${rawPreview.length > 160 ? \"...\" : \"\"}`\r\n                  : \"暂无预览\";\r\n              const tagList = (post.tags || \"\")\r\n                .split(/[,，]/)\r\n                .map((tag: string) => tag.trim())\r\n                .filter(Boolean);\r\n              const matchIndex = normalizedQuery\r\n                ? titleText.toLowerCase().indexOf(normalizedQuery)\r\n                : -1;\r\n              const firstImageMatch = (post.content || \"\").match(/!\\[.*?\\]\\((.*?)\\)|<img.*?src=[\"'](.*?)[\"']/);\r\n              const firstImageUrl = firstImageMatch ? (firstImageMatch[1] || firstImageMatch[2]) : null;\r\n              const thumbnailUrl = getThumbnailUrl(firstImageUrl, 400);\r\n              const effectiveAvatar = post.author === profileData?.username && profileData?.avatar_url\r\n                ? profileData.avatar_url\r\n                : post.author_avatar;\r\n              const avatarUrl = getThumbnailUrl(effectiveAvatar || \"\", 64);\r\n\r\n              return (\r\n                <div key={post.slug} className=\"card block no-underline text-inherit\">\r\n                  <Link href={`/post/${post.slug}`} className=\"block no-underline text-inherit\">\r\n                  <div className=\"card-head flex justify-between items-start mb-3\">\r\n                    <div className=\"author flex items-center gap-2\">\r\n                      {post.author_avatar ? (\r\n                        <img\r\n                          src={avatarUrl}\r\n                          alt={post.author_name}\r\n                          loading=\"lazy\"\r\n                          decoding=\"async\"\r\n                          className=\"w-6 h-6 rounded-full\"\r\n                        />\r\n                      ) : (\r\n                        <div className=\"avatar-fallback w-6 h-6 text-xs\">{post.author_name?.[0] || \"U\"}</div>\r\n                      )}\r\n                      <span className=\"text-sm font-medium\">{post.author_name || post.author || \"匿名\"}</span>\r\n                    </div>\r\n                    <span className=\"text-xs text-muted\">{new Date(post.created_at).toLocaleString()}</span>\r\n                  </div>\r\n\r\n                  <h2 className=\"text-xl font-bold mb-3 leading-tight\">\r\n                    {matchIndex >= 0 ? (\r\n                      <>\r\n                        {titleText.slice(0, matchIndex)}\r\n                        <span className=\"highlight\">\r\n                          {titleText.slice(matchIndex, matchIndex + normalizedQuery.length)}\r\n                        </span>\r\n                        {titleText.slice(matchIndex + normalizedQuery.length)}\r\n                      </>\r\n                    ) : (\r\n                      titleText\r\n                    )}\r\n                  </h2>\r\n\r\n                  <p className=\"excerpt text-muted text-sm mb-6 line-clamp-2 leading-relaxed\">\r\n                    {preview}\r\n                  </p>\r\n\r\n                  </Link>\r\n\r\n                  <div className=\"post-card-footer flex justify-between items-center mt-auto\">\r\n                    <div className=\"tag-list\">\r\n                      {tagList.map((tag: string) => (\r\n                        <span key={tag} className=\"tag-pill\">#{tag}</span>\r\n                      ))}\r\n                    </div>\r\n\r\n                    <div className=\"post-card-actions flex gap-1\">\r\n                      <button\r\n                        className=\"btn-ghost btn-sm\"\r\n                        type=\"button\"\r\n                        onClick={(event) => {\r\n                          event.preventDefault();\r\n                          event.stopPropagation();\r\n                          const token = tokenValue;\r\n                          if (!token) {\r\n                            router.push(\"/login\");\r\n                            return;\r\n                          }\r\n                          fetch(`/api/blog/${post.slug}/like`, {\r\n                            method: \"POST\",\r\n                            headers: { Authorization: `Bearer ${token}` },\r\n                          })\r\n                            .then((res) => res.json())\r\n                            .then((data) => {\r\n                              if (!data) return;\r\n                              applyPostUpdates((prev) =>\r\n                                prev.map((item) =>\r\n                                  item.slug === post.slug\r\n                                    ? {\r\n                                      ...item,\r\n                                      like_count: data.like_count ?? item.like_count,\r\n                                      dislike_count: data.dislike_count ?? item.dislike_count,\r\n                                      comment_count: data.comment_count ?? item.comment_count,\r\n                                      favorite_count: data.favorite_count ?? item.favorite_count,\r\n                                    }\r\n                                    : item,\r\n                                ),\r\n                              );\r\n                            })\r\n                            .catch(() => {});\r\n                        }}\r\n                      >\r\n                        <ThumbsUpIcon className=\"inline\" /> {post.like_count ?? 0}\r\n                      </button>\r\n                      <button\r\n                        className=\"btn-ghost btn-sm\"\r\n                        type=\"button\"\r\n                        onClick={(event) => {\r\n                          event.preventDefault();\r\n                          event.stopPropagation();\r\n                          const token = tokenValue;\r\n                          if (!token) {\r\n                            router.push(\"/login\");\r\n                            return;\r\n                          }\r\n                          fetch(`/api/blog/${post.slug}/dislike`, {\r\n                            method: \"POST\",\r\n                            headers: { Authorization: `Bearer ${token}` },\r\n                          })\r\n                            .then((res) => res.json())\r\n                            .then((data) => {\r\n                              if (!data) return;\r\n                              applyPostUpdates((prev) =>\r\n                                prev.map((item) =>\r\n                                  item.slug === post.slug\r\n                                    ? {\r\n                                      ...item,\r\n                                      like_count: data.like_count ?? item.like_count,\r\n                                      dislike_count: data.dislike_count ?? item.dislike_count,\r\n                                      comment_count: data.comment_count ?? item.comment_count,\r\n                                      favorite_count: data.favorite_count ?? item.favorite_count,\r\n                                    }\r\n                                    : item,\r\n                                ),\r\n                              );\r\n                            })\r\n                            .catch(() => {});\r\n                        }}\r\n                      >\r\n                        <ThumbsDownIcon className=\"inline\" /> {post.dislike_count ?? 0}\r\n                      </button>\r\n                      <button\r\n                        className={`btn-ghost btn-sm ${post.favorited_by_me ? \"text-accent\" : \"\"}`}\r\n                        type=\"button\"\r\n                        onClick={(event) => {\r\n                          event.preventDefault();\r\n                          event.stopPropagation();\r\n                          const token = tokenValue;\r\n                          if (!token) {\r\n                            router.push(\"/login\");\r\n                            return;\r\n                          }\r\n                          fetch(`/api/blog/${post.slug}/favorite`, {\r\n                            method: \"POST\",\r\n                            headers: { Authorization: `Bearer ${token}` },\r\n                          })\r\n                            .then((res) => res.json())\r\n                            .then((data) => {\r\n                              if (!data) return;\r\n                              applyPostUpdates((prev) =>\r\n                                prev.map((item) =>\r\n                                  item.slug === post.slug\r\n                                    ? {\r\n                                      ...item,\r\n                                      like_count: data.like_count ?? item.like_count,\r\n                                      dislike_count: data.dislike_count ?? item.dislike_count,\r\n                                      comment_count: data.comment_count ?? item.comment_count,\r\n                                      favorite_count: data.favorite_count ?? item.favorite_count,\r\n                                      favorited_by_me: data.favorited ?? item.favorited_by_me,\r\n                                    }\r\n                                    : item,\r\n                                ),\r\n                              );\r\n                            })\r\n                            .catch(() => {});\r\n                        }}\r\n                      >\r\n                        <BookmarkIcon filled={post.favorited_by_me} className=\"inline\" /> {post.favorite_count ?? 0}\r\n                      </button>\r\n                      <button\r\n                        className=\"btn-ghost btn-sm\"\r\n                        type=\"button\"\r\n                        onClick={(event) => {\r\n                          event.preventDefault();\r\n                          event.stopPropagation();\r\n                          router.push(`/post/${post.slug}#comments`);\r\n                        }}\r\n                      >\r\n                        <MessageCircleIcon className=\"inline\" /> {post.comment_count ?? 0}\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n          {totalPages > 1 && (\r\n            <div className=\"pagination flex items-center justify-center gap-4 mt-8\">\r\n              <button\r\n                className=\"btn-ghost\"\r\n                type=\"button\"\r\n                onClick={() => setCurrentPage((p) => Math.max(1, p - 1))}\r\n                disabled={currentPage === 1}\r\n              >\r\n                上一页\r\n              </button>\r\n              <span className=\"text-muted text-sm\">\r\n                第 {currentPage} / {totalPages} 页\r\n              </span>\r\n              <button\r\n                className=\"btn-ghost\"\r\n                type=\"button\"\r\n                onClick={() => setCurrentPage((p) => Math.min(totalPages, p + 1))}\r\n                disabled={currentPage === totalPages}\r\n              >\r\n                下一页\r\n              </button>\r\n            </div>\r\n          )}\r\n        </section>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\BlogPostPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadComments' and 'loadPost'. Either include them or remove the dependency array.","line":159,"column":6,"nodeType":"ArrayExpression","endLine":159,"endColumn":31,"suggestions":[{"desc":"Update the dependencies array to be: [slug, cacheKeySignature, loadPost, loadComments]","fix":{"range":[6073,6098],"text":"[slug, cacheKeySignature, loadPost, loadComments]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadComments' and 'loadPost'. Either include them or remove the dependency array.","line":168,"column":6,"nodeType":"ArrayExpression","endLine":168,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadComments, loadPost]","fix":{"range":[6332,6334],"text":"[loadComments, loadPost]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'cacheUserKeys', 'loadComments', 'loadPost', 'localCommentKeys', and 'localPostKeys'. Either include them or remove the dependency array.","line":209,"column":6,"nodeType":"ArrayExpression","endLine":209,"endColumn":31,"suggestions":[{"desc":"Update the dependencies array to be: [slug, cacheKeySignature, cacheUserKeys, localPostKeys, localCommentKeys, loadPost, loadComments]","fix":{"range":[7466,7491],"text":"[slug, cacheKeySignature, cacheUserKeys, localPostKeys, localCommentKeys, loadPost, loadComments]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'replaceImageSrc' is defined but never used.","line":411,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":411,"endColumn":27},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":528,"column":13,"nodeType":"JSXOpeningElement","endLine":534,"endColumn":15},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":650,"column":17,"nodeType":"JSXOpeningElement","endLine":656,"endColumn":19},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":854,"column":19,"nodeType":"JSXOpeningElement","endLine":864,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿\r\n\"use client\";\r\n\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { useParams, useRouter } from \"next/navigation\";\r\nimport { getThumbnailUrl } from \"@/utils/url\";\r\nimport { ThumbsUpIcon, ThumbsDownIcon, BookmarkIcon, MessageCircleIcon } from \"@/components/Icons\";\r\nimport { marked } from \"marked\";\r\nimport { useAuth } from \"@/app/providers\";\r\nimport {\r\n  clearAllListCache,\r\n  clearPostCache,\r\n  getCommentsCache,\r\n  getPostCache,\r\n  setCommentsCache,\r\n  setPostCache,\r\n  clearAllCaches,\r\n} from \"@/utils/memoryStore\";\r\nimport { resizeImageFile } from \"@/utils/image\";\r\nimport { getCachedJson, setCachedJson } from \"@/utils/cache\";\r\n\r\nexport default function BlogPostPage() {\r\n  const params = useParams<{ slug: string }>();\r\n  const slugParam = params?.slug;\r\n  const slug = Array.isArray(slugParam) ? slugParam[0] : slugParam;\r\n  const router = useRouter();\r\n  const [post, setPost] = useState<any>(null);\r\n  const [status, setStatus] = useState(\"loading\");\r\n  const [comments, setComments] = useState<any[]>([]);\r\n  const [commentText, setCommentText] = useState(\"\");\r\n  const [commentStatus, setCommentStatus] = useState(\"\");\r\n  const [commentLoading, setCommentLoading] = useState(false);\r\n  const [commentListStatus, setCommentListStatus] = useState<\"loading\" | \"ready\" | \"error\">(\"loading\");\r\n  const [replyTo, setReplyTo] = useState<any>(null);\r\n  const [commentPage, setCommentPage] = useState(1);\r\n  const commentsPerPage = 5;\r\n  const [expandedReplies, setExpandedReplies] = useState<Record<string, boolean>>({});\r\n  const [isEditing, setIsEditing] = useState(false);\r\n  const [editTitle, setEditTitle] = useState(\"\");\r\n  const [editContent, setEditContent] = useState(\"\");\r\n  const [editTags, setEditTags] = useState(\"\");\r\n  const [editStatus, setEditStatus] = useState(\"\");\r\n  const [imageWidth, setImageWidth] = useState(\"\");\r\n  const [pendingImageFile, setPendingImageFile] = useState<File | null>(null);\r\n  const [pendingPreviewUrl, setPendingPreviewUrl] = useState(\"\");\r\n  const [selectedImage, setSelectedImage] = useState<string | null>(null);\r\n  const [imageSizePercent, setImageSizePercent] = useState(100);\r\n  const [showSizeModal, setShowSizeModal] = useState(false);\r\n  const editPreviewRef = useRef<HTMLDivElement | null>(null);\r\n  const imageReplaceInputRef = useRef<HTMLInputElement | null>(null);\r\n  const refreshCommentsTimer = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n\r\n  const { user: profile, token, isAuthenticated } = useAuth();\r\n\r\n  const canEdit = profile?.username && post?.author && profile.username === post.author;\r\n  const cacheUserKeys = [profile?.username || \"anon\"];\r\n  const cacheKeySignature = `${cacheUserKeys.join(\"|\")}:${slug}`;\r\n  const localPostKeys = cacheUserKeys.map((key) => `cache:post:${key}:${slug}`);\r\n  const localCommentKeys = cacheUserKeys.map((key) => `cache:comments:${key}:${slug}`);\r\n\r\n  function slugify(text: string) {\r\n    return String(text || \"\")\r\n      .trim()\r\n      .toLowerCase()\r\n      .replace(/[^a-z0-9\\u4e00-\\u9fa5]+/g, \"-\")\r\n      .replace(/^-+|-+$/g, \"\");\r\n  }\r\n\r\n  function loadPost(options: { force?: boolean } = {}) {\r\n    const { force = false } = options;\r\n    if (!slug) return;\r\n    if (!force) {\r\n      for (const key of cacheUserKeys) {\r\n        const cached = getPostCache(`${key}:${slug}`);\r\n        if (cached) {\r\n          setPost(cached);\r\n          setStatus(\"ready\");\r\n          return;\r\n        }\r\n      }\r\n      for (const key of localPostKeys) {\r\n        const cached = getCachedJson(key);\r\n        if (cached) {\r\n          setPost(cached);\r\n          setStatus(\"ready\");\r\n          return;\r\n        }\r\n      }\r\n    }\r\n    const authToken = token;\r\n    fetch(`/api/blog/${slug}`, {\r\n      headers: authToken ? { Authorization: `Bearer ${authToken}` } : {},\r\n    })\r\n      .then((res) => res.json())\r\n      .then((data) => {\r\n        setPost(data);\r\n        cacheUserKeys.forEach((key) => setPostCache(`${key}:${slug}`, data));\r\n        localPostKeys.forEach((key) => setCachedJson(key, data));\r\n        setStatus(\"ready\");\r\n      })\r\n      .catch(() => setStatus(\"error\"));\r\n  }\r\n\r\n  function loadComments(options: { force?: boolean } = {}) {\r\n    const { force = false } = options;\r\n    if (!slug) return;\r\n    if (!force) {\r\n      for (const key of cacheUserKeys) {\r\n        const cached = getCommentsCache(`${key}:${slug}`);\r\n        if (cached) {\r\n          setComments(Array.isArray(cached) ? cached : []);\r\n          setCommentListStatus(\"ready\");\r\n          return;\r\n        }\r\n      }\r\n      for (const key of localCommentKeys) {\r\n        const cached = getCachedJson(key);\r\n        if (cached) {\r\n          setComments(Array.isArray(cached) ? cached : []);\r\n          setCommentListStatus(\"ready\");\r\n          return;\r\n        }\r\n      }\r\n    }\r\n    setCommentListStatus(\"loading\");\r\n    fetch(`/api/blog/${slug}/comments`)\r\n      .then((res) => res.json())\r\n      .then((data) => {\r\n        const list = Array.isArray(data) ? data : [];\r\n        setComments(list);\r\n        cacheUserKeys.forEach((key) => setCommentsCache(`${key}:${slug}`, list));\r\n        localCommentKeys.forEach((key) => setCachedJson(key, list));\r\n        setCommentListStatus(\"ready\");\r\n      })\r\n      .catch(() => {\r\n        setComments([]);\r\n        setCommentListStatus(\"error\");\r\n      });\r\n  }\r\n\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    const handler = () => {\r\n      clearAllCaches();\r\n      try {\r\n        Object.keys(localStorage).forEach((key) => {\r\n          if (key.startsWith(\"cache:blog:\") || key.startsWith(\"cache:post:\") || key.startsWith(\"cache:comments:\") || key.startsWith(\"cache:favorites:\") || key.startsWith(\"cache:profile:\")) {\r\n            localStorage.removeItem(key);\r\n          }\r\n        });\r\n      } catch {}\r\n      loadPost({ force: true });\r\n      loadComments({ force: true });\r\n    };\r\n    window.addEventListener(\"profile-updated\", handler as EventListener);\r\n    return () => window.removeEventListener(\"profile-updated\", handler as EventListener);\r\n  }, [slug, cacheKeySignature]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    const ts = localStorage.getItem(\"profile_updated_at\");\r\n    if (ts) {\r\n      loadPost({ force: true });\r\n      loadComments({ force: true });\r\n    }\r\n  }, []);\r\n  useEffect(() => {\r\n    if (!slug) return;\r\n    let cachedPost: any = null;\r\n    for (const key of cacheUserKeys) {\r\n      cachedPost = getPostCache(`${key}:${slug}`);\r\n      if (cachedPost) break;\r\n    }\r\n    if (!cachedPost) {\r\n      for (const key of localPostKeys) {\r\n        cachedPost = getCachedJson(key);\r\n        if (cachedPost) break;\r\n      }\r\n    }\r\n    let cachedComments: any = null;\r\n    for (const key of cacheUserKeys) {\r\n      cachedComments = getCommentsCache(`${key}:${slug}`);\r\n      if (cachedComments) break;\r\n    }\r\n    if (!cachedComments) {\r\n      for (const key of localCommentKeys) {\r\n        cachedComments = getCachedJson(key);\r\n        if (cachedComments) break;\r\n      }\r\n    }\r\n    if (cachedPost) {\r\n      setPost(cachedPost);\r\n      setStatus(\"ready\");\r\n    } else {\r\n      setStatus(\"loading\");\r\n    }\r\n    if (cachedComments) {\r\n      setComments(Array.isArray(cachedComments) ? cachedComments : []);\r\n      setCommentListStatus(\"ready\");\r\n    }\r\n    if (!cachedPost) {\r\n      loadPost({ force: true });\r\n    }\r\n    if (!cachedComments) {\r\n      loadComments({ force: true });\r\n    }\r\n  }, [slug, cacheKeySignature]);\r\n\r\n  useEffect(() => {\r\n    if (post) {\r\n      setEditTitle(post.title || \"\");\r\n      setEditContent(post.content || \"\");\r\n      setEditTags(post.tags || \"\");\r\n    }\r\n  }, [post]);\r\n\r\n  async function handleLike() {\r\n    const authToken = token;\r\n    if (!authToken || !slug) {\r\n      router.push(\"/login\");\r\n      return;\r\n    }\r\n    const res = await fetch(`/api/blog/${slug}/like`, {\r\n      method: \"POST\",\r\n      headers: { Authorization: `Bearer ${authToken}` },\r\n    });\r\n    if (!res.ok) {\r\n      return;\r\n    }\r\n    await res.json().catch(() => ({}));\r\n    loadPost({ force: true });\r\n  }\r\n\r\n  function scheduleCommentsRefresh() {\r\n    if (refreshCommentsTimer.current) {\r\n      clearTimeout(refreshCommentsTimer.current);\r\n    }\r\n    refreshCommentsTimer.current = setTimeout(() => {\r\n      loadComments({ force: true });\r\n    }, 800);\r\n  }\r\n\r\n  async function handleComment(event: React.FormEvent) {\r\n    event.preventDefault();\r\n    if (commentLoading) return;\r\n    setCommentStatus(\"\");\r\n    const trimmed = commentText.trim();\r\n    if (!trimmed) {\r\n      setCommentStatus(\"请输入评论内容。\");\r\n      return;\r\n    }\r\n    if (!slug) return;\r\n    setCommentLoading(true);\r\n    try {\r\n      const authToken = token;\r\n      const res = await fetch(`/api/blog/${slug}/comments`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          ...(authToken ? { Authorization: `Bearer ${authToken}` } : {}),\r\n        },\r\n        body: JSON.stringify({\r\n          content: replyTo\r\n            ? trimmed.startsWith(\"@\")\r\n              ? trimmed\r\n              : `@${replyTo.author_name || replyTo.author} ${trimmed}`\r\n            : trimmed,\r\n          author: profile?.nickname || profile?.username || \"访客\",\r\n          parent_id: replyTo?.root_id || replyTo?.id || null,\r\n        }),\r\n      });\r\n      if (!res.ok) {\r\n        const data = await res.json().catch(() => ({}));\r\n        setCommentStatus(data.detail || \"评论失败。\");\r\n        return;\r\n      }\r\n      setCommentText(\"\");\r\n      setReplyTo(null);\r\n      setCommentStatus(\"评论已发布。\");\r\n      setCommentPage(1);\r\n      loadComments({ force: true });\r\n      loadPost({ force: true });\r\n    } finally {\r\n      setCommentLoading(false);\r\n    }\r\n  }\r\n\r\n  async function handleSaveEdit() {\r\n    setEditStatus(\"\");\r\n    if (!editTitle.trim() || !editContent.trim()) {\r\n      setEditStatus(\"标题和内容不能为空。\");\r\n      return;\r\n    }\r\n    const authToken = token;\r\n    if (!authToken || !slug) {\r\n      setEditStatus(\"请先登录。\");\r\n      return;\r\n    }\r\n    const res = await fetch(`/api/blog/${slug}`, {\r\n      method: \"PUT\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        ...(authToken ? { Authorization: `Bearer ${authToken}` } : {}),\r\n      },\r\n      body: JSON.stringify({\r\n        title: editTitle,\r\n        content: editContent,\r\n        tags: editTags,\r\n      }),\r\n    });\r\n    if (!res.ok) {\r\n      const data = await res.json().catch(() => ({}));\r\n      setEditStatus(data.detail || \"保存失败。\");\r\n      return;\r\n    }\r\n    setIsEditing(false);\r\n    clearPostCache(slug);\r\n    clearAllListCache();\r\n    try {\r\n      Object.keys(localStorage).forEach((key) => {\r\n        if (key.startsWith(\"cache:blog:\") || key.startsWith(\"cache:post:\")) {\r\n          localStorage.removeItem(key);\r\n        }\r\n      });\r\n    } catch {}\r\n    loadPost({ force: true });\r\n  }\r\n\r\n  function insertImageMarkup(url: string, widthValue: string) {\r\n    const markup = widthValue\r\n      ? `<img src=\"${url}\" style=\"max-width: 100%; width: ${widthValue};\" />`\r\n      : `![](${url})`;\r\n    setEditContent((prev) => `${prev}\\n\\n${markup}\\n`);\r\n  }\r\n\r\n  function handleImageSelect(file: File | undefined, replaceSrc: string | null = null) {\r\n    if (!file) return;\r\n    if (pendingPreviewUrl) {\r\n      URL.revokeObjectURL(pendingPreviewUrl);\r\n    }\r\n    const preview = URL.createObjectURL(file);\r\n    setPendingImageFile(file);\r\n    setPendingPreviewUrl(preview);\r\n    setSelectedImage(replaceSrc || null);\r\n    setShowSizeModal(true);\r\n  }\r\n\r\n  async function uploadImage(file: File) {\r\n    const authToken = token;\r\n    if (!authToken) {\r\n      setEditStatus(\"请先登录。\");\r\n      return null;\r\n    }\r\n    const resized = await resizeImageFile(file, 1600);\r\n    const formData = new FormData();\r\n    formData.append(\"file\", resized);\r\n    const res = await fetch(\"/api/upload-image\", {\r\n      method: \"POST\",\r\n      headers: { Authorization: `Bearer ${authToken}` },\r\n      body: formData,\r\n    });\r\n    if (!res.ok) {\r\n      setEditStatus(\"上传失败。\");\r\n      return null;\r\n    }\r\n    const data = await res.json();\r\n    return data.url || null;\r\n  }\r\n\r\n  function removeSelectedImage() {\r\n    if (!selectedImage) return;\r\n    const escaped = selectedImage.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\r\n    const markdownPattern = new RegExp(`!\\\\[[^\\\\]]*\\\\]\\\\(${escaped}\\\\)`, \"g\");\r\n    const htmlPattern = new RegExp(`<img[^>]*src=[\"']${escaped}[\"'][^>]*>`, \"g\");\r\n    setEditContent((prev) => prev.replace(markdownPattern, \"\").replace(htmlPattern, \"\"));\r\n    setSelectedImage(null);\r\n    setShowSizeModal(false);\r\n    if (pendingPreviewUrl) {\r\n      URL.revokeObjectURL(pendingPreviewUrl);\r\n      setPendingPreviewUrl(\"\");\r\n    }\r\n    setPendingImageFile(null);\r\n  }\r\n\r\n  function getImageWidthFromContent(src: string | null) {\r\n    if (!src) return null;\r\n    const escaped = src.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\r\n    const htmlPattern = new RegExp(`<img[^>]*src=[\"']${escaped}[\"'][^>]*>`, \"g\");\r\n    const match = editContent.match(htmlPattern);\r\n    if (!match) return null;\r\n    const tag = match[0];\r\n    const widthMatch = tag.match(/width:\\s*([^;\"]+)/i);\r\n    if (!widthMatch) return null;\r\n    return widthMatch[1].trim();\r\n  }\r\n\r\n  function applyImageSize(widthValue: string) {\r\n    if (!selectedImage) return;\r\n    const escaped = selectedImage.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\r\n    const htmlPattern = new RegExp(`<img[^>]*src=[\"']${escaped}[\"'][^>]*>`, \"g\");\r\n    const markdownPattern = new RegExp(`!\\\\[[^\\\\]]*\\\\]\\\\(${escaped}\\\\)`, \"g\");\r\n    const replacement = `<img src=\"${selectedImage}\" style=\"max-width: 100%; width: ${widthValue};\" />`;\r\n    const updated = editContent\r\n      .replace(htmlPattern, replacement)\r\n      .replace(markdownPattern, replacement);\r\n    setEditContent(updated);\r\n  }\r\n\r\n  function replaceImageSrc(oldSrc: string, newSrc: string, widthValue: string) {\r\n    const escaped = oldSrc.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\r\n    const htmlPattern = new RegExp(`<img[^>]*src=[\"']${escaped}[\"'][^>]*>`, \"g\");\r\n    const markdownPattern = new RegExp(`!\\\\[[^\\\\]]*\\\\]\\\\(${escaped}\\\\)`, \"g\");\r\n    const replacement = `<img src=\"${newSrc}\" style=\"max-width: 100%; width: ${widthValue};\" />`;\r\n    const updated = editContent\r\n      .replace(htmlPattern, replacement)\r\n      .replace(markdownPattern, replacement);\r\n    setEditContent(updated);\r\n    setSelectedImage(newSrc);\r\n  }\r\n\r\n  const tagList: string[] = (post?.tags || \"\")\r\n    .split(/[,，]/)\r\n    .map((tag: string) => tag.trim())\r\n    .filter(Boolean);\r\n\r\n  const readingStats = useMemo(() => {\r\n    const text = String(post?.content || \"\")\r\n      .replace(/```[\\s\\S]*?```/g, \" \")\r\n      .replace(/`[^`]*`/g, \" \")\r\n      .replace(/!\\[[^\\]]*\\]\\([^)]*\\)/g, \" \")\r\n      .replace(/\\[[^\\]]*\\]\\([^)]*\\)/g, \" \")\r\n      .replace(/[#>*_\\-]+/g, \" \")\r\n      .replace(/\\s+/g, \" \")\r\n      .trim();\r\n    const length = text.length;\r\n    const minutes = Math.max(1, Math.ceil(length / 400));\r\n    return { length, minutes };\r\n  }, [post?.content]);\r\n\r\n  const { html: markdownHtml, toc: tocItems } = useMemo(() => {\r\n    const items: Array<{ id: string; text: string; level: number }> = [];\r\n    const slugCounts = new Map<string, number>();\r\n    const renderer = new marked.Renderer();\r\n    renderer.heading = (text: string, level: number, raw: string) => {\r\n      const base = slugify(raw || text);\r\n      const count = slugCounts.get(base) || 0;\r\n      const nextCount = count + 1;\r\n      slugCounts.set(base, nextCount);\r\n      const id = count ? `${base}-${nextCount}` : base || `section-${items.length + 1}`;\r\n      items.push({ id, text, level });\r\n      return `<h${level} id=\"${id}\">${text}</h${level}>`;\r\n    };\r\n    renderer.image = (href: string | null, title: string | null, text: string) => {\r\n      const safeTitle = title ? ` title=\"${title}\"` : \"\";\r\n      const alt = text || \"\";\r\n      return `<img src=\"${href}\" alt=\"${alt}\" loading=\"lazy\" decoding=\"async\"${safeTitle} style=\"max-width: 100%; height: auto;\" />`;\r\n    };\r\n    const html = marked.parse(post?.content || \"\", { renderer });\r\n    return { html, toc: items };\r\n  }, [post?.content]);\r\n\r\n  const editPreviewHtml = useMemo(() => {\r\n    const renderer = new marked.Renderer();\r\n    renderer.image = (href: string | null, title: string | null, text: string) => {\r\n      const safeTitle = title ? ` title=\"${title}\"` : \"\";\r\n      const alt = text || \"\";\r\n      return `<img src=\"${href}\" alt=\"${alt}\" loading=\"lazy\" decoding=\"async\"${safeTitle} style=\"max-width: 100%; height: auto;\" />`;\r\n    };\r\n    return marked.parse(editContent || \"\", { renderer });\r\n  }, [editContent]);\r\n\r\n  function buildCommentTree(list: any[]) {\r\n    const nodes = new Map<string, any>();\r\n    const roots: any[] = [];\r\n    list.forEach((item) => {\r\n      nodes.set(item.id, { ...item, children: [] });\r\n    });\r\n    nodes.forEach((node) => {\r\n      if (node.parent_id && nodes.has(node.parent_id)) {\r\n        const parent = nodes.get(node.parent_id);\r\n        node.reply_to = parent.author_name || parent.author || \"访客\";\r\n        node.reply_to_id = parent.id;\r\n        node.root_id = parent.root_id || parent.id;\r\n        parent.children.push(node);\r\n      } else {\r\n        node.root_id = node.id;\r\n        roots.push(node);\r\n      }\r\n    });\r\n    const sortByDate = (a: any, b: any) =>\r\n      new Date(b.created_at).getTime() - new Date(a.created_at).getTime();\r\n    const sortTree = (items: any[]) => {\r\n      items.sort(sortByDate);\r\n      items.forEach((child) => sortTree(child.children));\r\n    };\r\n    sortTree(roots);\r\n    return roots;\r\n  }\r\n\r\n  const commentRoots = buildCommentTree(comments);\r\n  const totalCommentPages = Math.max(1, Math.ceil(commentRoots.length / commentsPerPage));\r\n  const pagedRoots = commentRoots.slice(\r\n    (commentPage - 1) * commentsPerPage,\r\n    commentPage * commentsPerPage,\r\n  );\r\n\r\n  function handleReplyClick(comment: any) {\r\n    const name = comment.author_name || comment.author || \"访客\";\r\n    const prefix = `@${name} `;\r\n    setReplyTo(comment);\r\n    setCommentText((value) => (value.startsWith(prefix) ? value : prefix));\r\n  }\r\n\r\n  function renderComment(node: any, depth = 0) {\r\n    const isReply = depth > 0;\r\n    const isExpanded = !!expandedReplies[node.id];\r\n    const replySlice = isExpanded ? node.children : node.children.slice(0, 5);\r\n    return (\r\n      <div\r\n        key={node.id}\r\n        id={`comment-${node.id}`}\r\n        className={`comment-item p-4 border-b border-subtle ${isReply ? \"ml-8 pl-4 border-l-2 border-l-subtle\" : \"\"}`}\r\n      >\r\n        <div className=\"flex gap-4\">\r\n          {node.author_avatar ? (\r\n            <img\r\n              src={getThumbnailUrl(node.author_avatar, 64)}\r\n              alt={node.author_name}\r\n              loading=\"lazy\"\r\n              decoding=\"async\"\r\n              className=\"w-8 h-8 rounded-full\"\r\n            />\r\n          ) : (\r\n            <div className=\"avatar-fallback w-8 h-8 text-xs\">{node.author_name?.[0] || \"U\"}</div>\r\n          )}\r\n          <div className=\"flex-1\">\r\n            <div className=\"flex items-center gap-2 mb-1\">\r\n              <strong className=\"text-sm\">{node.author_name || node.author}</strong>\r\n              <span className=\"text-xs px-2 py-0.5 rounded-full bg-accent/10 text-accent\">Lv1</span>\r\n              <span className=\"text-xs text-muted ml-auto\">{new Date(node.created_at).toLocaleString()}</span>\r\n            </div>\r\n            {node.reply_to && (\r\n              <div className=\"text-xs text-muted mb-2\">\r\n                回复 <a href={`#comment-${node.reply_to_id}`} className=\"text-accent hover:underline\">@{node.reply_to}</a>\r\n              </div>\r\n            )}\r\n            <p className=\"text-sm leading-relaxed mb-3 text-primary\">{node.content}</p>\r\n            <div className=\"flex gap-3 text-xs text-muted\">\r\n              <button\r\n                className=\"hover:text-primary transition-colors cursor-pointer\"\r\n                type=\"button\"\r\n                onClick={() => {\r\n                  const authToken = token;\r\n                  if (!authToken) {\r\n                    setCommentStatus(\"请先登录后再操作。\");\r\n                    return;\r\n                  }\r\n                  fetch(`/api/comment/${node.id}/like`, {\r\n                    method: \"POST\",\r\n                    headers: { Authorization: `Bearer ${authToken}` },\r\n                  })\r\n                    .then(() => scheduleCommentsRefresh())\r\n                    .catch(() => {});\r\n                }}\r\n              >\r\n                <ThumbsUpIcon className=\"inline\" /> {node.like_count ?? 0}\r\n              </button>\r\n              <button\r\n                className=\"hover:text-primary transition-colors cursor-pointer\"\r\n                type=\"button\"\r\n                onClick={() => {\r\n                  const authToken = token;\r\n                  if (!authToken) {\r\n                    setCommentStatus(\"请先登录后再操作。\");\r\n                    return;\r\n                  }\r\n                  fetch(`/api/comment/${node.id}/dislike`, {\r\n                    method: \"POST\",\r\n                    headers: { Authorization: `Bearer ${authToken}` },\r\n                  })\r\n                    .then(() => scheduleCommentsRefresh())\r\n                    .catch(() => {});\r\n                }}\r\n              >\r\n                <ThumbsDownIcon className=\"inline\" /> {node.dislike_count ?? 0}\r\n              </button>\r\n              <button\r\n                className=\"hover:text-primary transition-colors cursor-pointer\"\r\n                type=\"button\"\r\n                onClick={() => handleReplyClick(node)}\r\n              >\r\n                <MessageCircleIcon className=\"inline\" /> 回复\r\n              </button>\r\n            </div>\r\n\r\n            {depth === 0 && node.children.length > 0 && (\r\n              <div className=\"mt-4 space-y-4\">\r\n                {replySlice.map((child: any) => renderComment(child, depth + 1))}\r\n                {node.children.length > 5 && (\r\n                  <button\r\n                    className=\"text-xs text-accent hover:underline mt-2\"\r\n                    type=\"button\"\r\n                    onClick={() =>\r\n                      setExpandedReplies((prev) => ({\r\n                        ...prev,\r\n                        [node.id]: !isExpanded,\r\n                      }))\r\n                    }\r\n                  >\r\n                    {isExpanded\r\n                      ? \"收起回复\"\r\n                      : `更多回复 (${node.children.length - 5})`}\r\n                  </button>\r\n                )}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n  return (\r\n    <div className=\"blog-post-page\">\r\n      <div className=\"post-toolbar mb-4 flex justify-between items-center\">\r\n        <div>\r\n          {canEdit && (\r\n            <button\r\n              className=\"btn-ghost\"\r\n              type=\"button\"\r\n              onClick={() => setIsEditing((value) => !value)}\r\n            >\r\n              {isEditing ? \"取消编辑\" : \"编辑\"}\r\n            </button>\r\n          )}\r\n        </div>\r\n        <Link className=\"btn-ghost\" href=\"/\">\r\n          返回讨论区\r\n        </Link>\r\n      </div>\r\n\r\n      {post?.title && <h1 className=\"text-3xl font-bold mb-4\">{post.title}</h1>}\r\n\r\n      {post && (\r\n        <div className=\"flex flex-col gap-4 mb-8 pb-8 border-b border-subtle\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-3\">\r\n              {post.author_avatar ? (\r\n                <img\r\n                  src={getThumbnailUrl(post.author_avatar, 96)}\r\n                  alt={post.author_name}\r\n                  loading=\"lazy\"\r\n                  decoding=\"async\"\r\n                  className=\"w-10 h-10 rounded-full\"\r\n                />\r\n              ) : (\r\n                <div className=\"avatar-fallback w-10 h-10 rounded-full flex items-center justify-center text-sm\">\r\n                  {post.author_name?.[0] || \"U\"}\r\n                </div>\r\n              )}\r\n              <div className=\"flex flex-col\">\r\n                <span className=\"font-bold text-lg\">{post.author_name || post.author}</span>\r\n                <div className=\"flex flex-wrap items-center gap-3 text-xs text-muted\">\r\n                  <span>{new Date(post.created_at).toLocaleString()}</span>\r\n                  <span>阅读 {readingStats.minutes} 分钟</span>\r\n                  <span>{readingStats.length} 字</span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex items-center gap-2\">\r\n              <button className=\"btn-ghost btn-sm\" type=\"button\" onClick={handleLike}>\r\n                <ThumbsUpIcon className=\"inline\" /> {post.like_count ?? 0}\r\n              </button>\r\n              <button\r\n                className={`btn-ghost btn-sm ${post.favorited_by_me ? \"text-accent\" : \"\"}`}\r\n                type=\"button\"\r\n                onClick={() => {\r\n                  const authToken = token;\r\n                  if (!authToken) {\r\n                    router.push(\"/login\");\r\n                    return;\r\n                  }\r\n                  fetch(`/api/blog/${slug}/favorite`, {\r\n                    method: \"POST\",\r\n                    headers: { Authorization: `Bearer ${authToken}` },\r\n                  })\r\n                    .then((res) => res.json())\r\n                    .then(() => loadPost({ force: true }))\r\n                    .catch(() => {});\r\n                }}\r\n              >\r\n                <BookmarkIcon filled={post.favorited_by_me} className=\"inline\" /> {post.favorite_count ?? 0}\r\n              </button>\r\n              <button\r\n                className=\"btn-ghost btn-sm\"\r\n                type=\"button\"\r\n                onClick={() => {\r\n                  const authToken = token;\r\n                  if (!authToken) {\r\n                    setCommentStatus(\"请先登录后再操作。\");\r\n                    return;\r\n                  }\r\n                  fetch(`/api/blog/${slug}/dislike`, {\r\n                    method: \"POST\",\r\n                    headers: { Authorization: `Bearer ${authToken}` },\r\n                  })\r\n                    .then((res) => res.json())\r\n                    .then(() => loadPost({ force: true }))\r\n                    .catch(() => {});\r\n                }}\r\n              >\r\n                <ThumbsDownIcon className=\"inline\" /> {post.dislike_count ?? 0}\r\n              </button>\r\n              <span className=\"btn-ghost btn-sm cursor-default\">\r\n                <MessageCircleIcon className=\"inline\" /> {comments.length ?? 0}\r\n              </span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n      {tagList.length > 0 && (\r\n        <div className=\"tag-list mb-6\">\r\n          {tagList.map((tag) => (\r\n            <span key={tag} className=\"tag-pill\">\r\n              #{tag}\r\n            </span>\r\n          ))}\r\n        </div>\r\n      )}\r\n\r\n      {status === \"error\" && <p>加载失败，请稍后再试。</p>}\r\n      {isEditing && (\r\n        <section className=\"card form\">\r\n          <label className=\"block mb-4\">\r\n            <span className=\"block text-sm font-medium mb-1\">标题</span>\r\n            <input\r\n              className=\"input\"\r\n              value={editTitle}\r\n              onChange={(event) => setEditTitle(event.target.value)}\r\n              placeholder=\"标题\"\r\n            />\r\n          </label>\r\n          <label className=\"block mb-4\">\r\n            <span className=\"block text-sm font-medium mb-1\">标签</span>\r\n            <input\r\n              className=\"input\"\r\n              value={editTags}\r\n              onChange={(event) => setEditTags(event.target.value)}\r\n              placeholder=\"tag1, tag2\"\r\n            />\r\n          </label>\r\n          <label>\r\n            <div className=\"flex justify-between items-center mb-2\">\r\n              <span className=\"text-sm font-medium\">内容</span>\r\n              <div className=\"flex gap-2 items-center\">\r\n                <input\r\n                  className=\"input\"\r\n                  style={{ width: \"200px\", display: \"inline-block\", padding: \"4px 8px\", fontSize: \"0.8rem\" }}\r\n                  value={imageWidth}\r\n                  onChange={(event) => setImageWidth(event.target.value)}\r\n                  placeholder=\"图片宽度...\"\r\n                />\r\n                <label className=\"btn-ghost btn-sm cursor-pointer m-0\">\r\n                  上传图片\r\n                  <input\r\n                    type=\"file\"\r\n                    accept=\"image/*\"\r\n                    style={{ display: \"none\" }}\r\n                    onChange={(event) => {\r\n                      const file = event.target.files?.[0];\r\n                      handleImageSelect(file);\r\n                      event.target.value = \"\";\r\n                    }}\r\n                  />\r\n                </label>\r\n              </div>\r\n            </div>\r\n            <textarea\r\n              className=\"input\"\r\n              rows={10}\r\n              value={editContent}\r\n              onChange={(event) => setEditContent(event.target.value)}\r\n              placeholder=\"写下内容...\"\r\n            />\r\n          </label>\r\n          <input\r\n            ref={imageReplaceInputRef}\r\n            type=\"file\"\r\n            accept=\"image/*\"\r\n            style={{ display: \"none\" }}\r\n            onChange={(event) => {\r\n              const file = event.target.files?.[0];\r\n              if (file && selectedImage) {\r\n                handleImageSelect(file, selectedImage);\r\n              }\r\n              event.target.value = \"\";\r\n            }}\r\n          />\r\n          <div className=\"card image-editor mt-4 mb-4\">\r\n            <div className=\"flex justify-between items-center mb-2 text-sm text-muted\">\r\n              <span>点击预览中的图片进行编辑。</span>\r\n              {selectedImage && (\r\n                <div className=\"flex gap-2\">\r\n                  <button\r\n                    className=\"btn-ghost btn-sm\"\r\n                    type=\"button\"\r\n                    onClick={() => imageReplaceInputRef.current?.click()}\r\n                  >\r\n                    替换\r\n                  </button>\r\n                  <button\r\n                    className=\"btn-ghost btn-sm\"\r\n                    type=\"button\"\r\n                    onClick={removeSelectedImage}\r\n                  >\r\n                    删除\r\n                  </button>\r\n                </div>\r\n              )}\r\n            </div>\r\n            <div\r\n              ref={editPreviewRef}\r\n              className=\"markdown markdown-preview p-4 border border-subtle rounded-lg\"\r\n              dangerouslySetInnerHTML={{ __html: editPreviewHtml }}\r\n              onClick={(event) => {\r\n                const target = event.target as HTMLElement;\r\n                if (target instanceof HTMLImageElement) {\r\n                  const src = target.getAttribute(\"src\");\r\n                  setSelectedImage(src);\r\n                  setPendingImageFile(null);\r\n                  if (pendingPreviewUrl) {\r\n                    URL.revokeObjectURL(pendingPreviewUrl);\r\n                    setPendingPreviewUrl(\"\");\r\n                  }\r\n                  const currentWidth = getImageWidthFromContent(src);\r\n                  if (currentWidth && currentWidth.endsWith(\"%\")) {\r\n                    const parsed = parseInt(currentWidth.replace(\"%\", \"\"), 10);\r\n                    if (!Number.isNaN(parsed)) {\r\n                      setImageSizePercent(parsed);\r\n                    }\r\n                  }\r\n                  setShowSizeModal(true);\r\n                }\r\n              }}\r\n            />\r\n          </div>\r\n          {showSizeModal && (selectedImage || pendingImageFile) && (\r\n            <div className=\"fixed inset-0 z-50\" style={{ background: \"rgba(0,0,0,0.8)\", position: \"fixed\", top: 0, left: 0, right: 0, bottom: 0, display: \"flex\", alignItems: \"center\", justifyContent: \"center\" }}>\r\n              <div className=\"card\" style={{ width: \"400px\", maxWidth: \"90%\" }}>\r\n                <h3 className=\"text-lg font-bold mb-4\">调整图片大小</h3>\r\n                <div className=\"mb-4 bg-black/20 p-2 rounded flex justify-center\" style={{ background: \"rgba(0,0,0,0.2)\" }}>\r\n                  <img\r\n                    src={pendingPreviewUrl || selectedImage || \"\"}\r\n                    alt=\"preview\"\r\n                    style={{\r\n                      maxWidth: \"100%\",\r\n                      maxHeight: \"300px\",\r\n                      width: imageWidth.trim()\r\n                        ? imageWidth.trim()\r\n                        : `${imageSizePercent}%`,\r\n                    }}\r\n                  />\r\n                </div>\r\n                <div className=\"flex items-center gap-2 mb-4\">\r\n                  <input\r\n                    type=\"range\"\r\n                    min=\"10\"\r\n                    max=\"100\"\r\n                    className=\"flex-1\"\r\n                    style={{ flex: 1 }}\r\n                    value={imageSizePercent}\r\n                    onChange={(event) => setImageSizePercent(Number(event.target.value))}\r\n                  />\r\n                  <span className=\"text-sm w-12 text-right\">{imageSizePercent}%</span>\r\n                </div>\r\n                <input\r\n                  className=\"input mb-4\"\r\n                  value={imageWidth}\r\n                  onChange={(event) => setImageWidth(event.target.value)}\r\n                  placeholder=\"或输入宽度，例如 360px / 60%\"\r\n                />\r\n                <div className=\"flex gap-2 justify-end\">\r\n                  {selectedImage && (\r\n                    <>\r\n                      <button\r\n                        className=\"btn-ghost\"\r\n                        type=\"button\"\r\n                        onClick={() => imageReplaceInputRef.current?.click()}\r\n                      >\r\n                        替换\r\n                      </button>\r\n                      <button\r\n                        className=\"btn-ghost\"\r\n                        type=\"button\"\r\n                        onClick={removeSelectedImage}\r\n                      >\r\n                        删除\r\n                      </button>\r\n                    </>\r\n                  )}\r\n                  <button\r\n                    className=\"btn-primary\"\r\n                    type=\"button\"\r\n                    onClick={async () => {\r\n                      const widthValue = imageWidth.trim()\r\n                        ? imageWidth.trim()\r\n                        : `${imageSizePercent}%`;\r\n                      if (selectedImage) {\r\n                        applyImageSize(widthValue);\r\n                      } else if (pendingImageFile) {\r\n                        const url = await uploadImage(pendingImageFile);\r\n                        if (url) {\r\n                          insertImageMarkup(url, widthValue);\r\n                        }\r\n                      }\r\n\r\n                      if (pendingPreviewUrl) {\r\n                        URL.revokeObjectURL(pendingPreviewUrl);\r\n                        setPendingPreviewUrl(\"\");\r\n                      }\r\n                      setPendingImageFile(null);\r\n                      setShowSizeModal(false);\r\n                    }}\r\n                  >\r\n                    确认\r\n                  </button>\r\n                  <button\r\n                    className=\"btn-ghost\"\r\n                    type=\"button\"\r\n                    onClick={() => {\r\n                      if (pendingPreviewUrl) {\r\n                        URL.revokeObjectURL(pendingPreviewUrl);\r\n                        setPendingPreviewUrl(\"\");\r\n                      }\r\n                      setPendingImageFile(null);\r\n                      setShowSizeModal(false);\r\n                    }}\r\n                  >\r\n                    取消\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n          {editStatus && <p className=\"text-accent mb-4\">{editStatus}</p>}\r\n          <div className=\"flex gap-2\">\r\n            <button className=\"btn-primary\" type=\"button\" onClick={handleSaveEdit}>\r\n              保存修改\r\n            </button>\r\n            <button className=\"btn-ghost\" type=\"button\" onClick={() => setIsEditing(false)}>\r\n              取消\r\n            </button>\r\n          </div>\r\n        </section>\r\n      )}\r\n      {status === \"ready\" && post && !isEditing && (\r\n        <>\r\n          <div className=\"post-layout\">\r\n            {tocItems.length > 0 && (\r\n              <aside className=\"toc\">\r\n                <div className=\"toc-title\">目录</div>\r\n                <ul>\r\n                  {tocItems.map((item) => (\r\n                    <li key={item.id} className={`toc-item level-${item.level}`}>\r\n                      <a href={`#${item.id}`}>{item.text}</a>\r\n                    </li>\r\n                  ))}\r\n                </ul>\r\n              </aside>\r\n            )}\r\n            <article className=\"markdown\" dangerouslySetInnerHTML={{ __html: markdownHtml }} />\r\n          </div>\r\n          {post.created_at && (\r\n            <div className=\"post-footer\">\r\n              <span className=\"muted\">发布时间：{new Date(post.created_at).toLocaleString()}</span>\r\n            </div>\r\n          )}\r\n        </>\r\n      )}\r\n\r\n      <section className=\"card comments\">\r\n        <form className=\"form\" onSubmit={handleComment}>\r\n          <label>\r\n            评论\r\n            <textarea\r\n              rows={4}\r\n              value={commentText}\r\n              onChange={(event) => setCommentText(event.target.value)}\r\n              onKeyDown={(event) => {\r\n                if (event.key === \"Enter\" && !event.shiftKey) {\r\n                  event.preventDefault();\r\n                  handleComment(event);\r\n                }\r\n              }}\r\n              placeholder={replyTo ? `回复 @${replyTo.author_name || replyTo.author}` : \"写下你的观点... (按 Enter 发送)\"}\r\n            />\r\n          </label>\r\n          {!isAuthenticated && (\r\n            <p className=\"text-xs text-muted mt-2\">未登录将以“访客”身份发表评论。</p>\r\n          )}\r\n          {commentStatus && <p className=\"status\">{commentStatus}</p>}\r\n          <div className=\"comment-form-actions\">\r\n            <button className=\"btn-primary\" type=\"submit\" style={{ display: \"flex\", alignItems: \"center\", gap: \"6px\" }} disabled={commentLoading}>\r\n              <span>评论</span>\r\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n                <line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\"></line>\r\n                <polygon points=\"22 2 15 22 11 13 2 9 22 2\"></polygon>\r\n              </svg>\r\n            </button>\r\n          </div>\r\n        </form>\r\n\r\n        <div className=\"comment-list\">\r\n          {commentListStatus === \"error\" && <p className=\"text-accent\">评论加载失败，请刷新重试。</p>}\r\n          {commentListStatus === \"ready\" && commentRoots.length === 0 && <p className=\"muted\">暂无评论。</p>}\r\n          {pagedRoots.map((comment) => renderComment(comment))}\r\n        </div>\r\n        {totalCommentPages > 1 && (\r\n          <div className=\"pagination\">\r\n            <button\r\n              className=\"button ghost\"\r\n              type=\"button\"\r\n              onClick={() => setCommentPage((p) => Math.max(1, p - 1))}\r\n              disabled={commentPage === 1}\r\n            >\r\n              上一页\r\n            </button>\r\n            <span className=\"muted\">\r\n              第 {commentPage} / {totalCommentPages} 页\r\n            </span>\r\n            <button\r\n              className=\"button ghost\"\r\n              type=\"button\"\r\n              onClick={() => setCommentPage((p) => Math.min(totalCommentPages, p + 1))}\r\n              disabled={commentPage === totalCommentPages}\r\n            >\r\n              下一页\r\n            </button>\r\n          </div>\r\n        )}\r\n      </section>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\ChannelList.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadChannels'. Either include it or remove the dependency array.","line":48,"column":6,"nodeType":"ArrayExpression","endLine":48,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadChannels]","fix":{"range":[1429,1431],"text":"[loadChannels]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadChannels'. Either include it or remove the dependency array.","line":62,"column":6,"nodeType":"ArrayExpression","endLine":62,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadChannels]","fix":{"range":[1912,1914],"text":"[loadChannels]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport * as channelService from \"@/services/channelService\";\r\n\r\ntype Channel = {\r\n  id: string | number;\r\n  name: string;\r\n  description?: string;\r\n  message_count?: number;\r\n};\r\n\r\nexport default function ChannelList({\r\n  selectedChannel,\r\n  onSelectChannel,\r\n}: {\r\n  selectedChannel: string | number | null;\r\n  onSelectChannel: (id: string | number) => void;\r\n}) {\r\n  const [channels, setChannels] = useState<Channel[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [profile, setProfile] = useState<any>(null);\r\n  const [token, setToken] = useState<string | null>(null);\r\n  const isAdmin = profile?.username === (process.env.NEXT_PUBLIC_ADMIN_USERNAME || \"witw\");\r\n  const [newChannelName, setNewChannelName] = useState(\"\");\r\n  const [newChannelDesc, setNewChannelDesc] = useState(\"\");\r\n  const [creating, setCreating] = useState(false);\r\n\r\n  const loadAuth = () => {\r\n    if (typeof window === \"undefined\") return;\r\n    const storedToken = localStorage.getItem(\"token\");\r\n    const storedProfile = localStorage.getItem(\"profile\");\r\n    let nextProfile: any = null;\r\n    if (storedProfile) {\r\n      try {\r\n        nextProfile = JSON.parse(storedProfile);\r\n      } catch {\r\n        nextProfile = null;\r\n      }\r\n    }\r\n    setToken(storedToken);\r\n    setProfile(nextProfile);\r\n  };\r\n\r\n  useEffect(() => {\r\n    loadAuth();\r\n    loadChannels();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    const handler = () => {\r\n      loadAuth();\r\n      loadChannels();\r\n    };\r\n    window.addEventListener(\"profile-updated\", handler as EventListener);\r\n    window.addEventListener(\"storage\", handler as EventListener);\r\n    return () => {\r\n      window.removeEventListener(\"profile-updated\", handler as EventListener);\r\n      window.removeEventListener(\"storage\", handler as EventListener);\r\n    };\r\n  }, []);\r\n\r\n  const handleCreate = async () => {\r\n    const name = newChannelName.trim();\r\n    if (!name || creating) return;\r\n    try {\r\n      setCreating(true);\r\n      await channelService.createChannel(name, newChannelDesc.trim(), token);\r\n      setNewChannelName(\"\");\r\n      setNewChannelDesc(\"\");\r\n      await loadChannels();\r\n    } catch (error: any) {\r\n      alert(error.message || \"\\u521b\\u5efa\\u5931\\u8d25\");\r\n    } finally {\r\n      setCreating(false);\r\n    }\r\n  };\r\n\r\n  const loadChannels = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const data = await channelService.getChannels();\r\n      setChannels(data);\r\n\r\n      if (!selectedChannel && data.length > 0) {\r\n        onSelectChannel(data[0].id);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to load channels:\", error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"channel-list\">\r\n      <h3 className=\"text-lg font-bold mb-4\">讨论频道</h3>\r\n      {isAdmin && (\r\n        <div className=\"card p-4 mb-4\">\r\n          <div className=\"text-sm font-medium mb-2\">{\"\\u6dfb\\u52a0\\u9891\\u9053\"}</div>\r\n          <input\r\n            className=\"input mb-2\"\r\n            placeholder={\"\\u9891\\u9053\\u540d\\u79f0\"}\r\n            value={newChannelName}\r\n            onChange={(event) => setNewChannelName(event.target.value)}\r\n          />\r\n          <textarea\r\n            className=\"input mb-2\"\r\n            placeholder={\"\\u9891\\u9053\\u63cf\\u8ff0\\uff08\\u53ef\\u9009\\uff09\"}\r\n            value={newChannelDesc}\r\n            onChange={(event) => setNewChannelDesc(event.target.value)}\r\n          />\r\n          <button\r\n            className=\"btn-primary w-full justify-center\"\r\n            type=\"button\"\r\n            onClick={handleCreate}\r\n            disabled={creating || !newChannelName.trim()}\r\n          >\r\n            {creating ? \"\\u521b\\u5efa\\u4e2d...\" : \"\\u521b\\u5efa\\u9891\\u9053\"}\r\n          </button>\r\n        </div>\r\n      )}\r\n      <div className=\"flex flex-col gap-2\">\r\n        {channels.map((channel) => (\r\n          <button\r\n            key={channel.id}\r\n            onClick={() => onSelectChannel(channel.id)}\r\n            className={`channel-item ${selectedChannel === channel.id ? \"active\" : \"\"}`}\r\n          >\r\n            <div className=\"channel-name font-medium\">{channel.name}</div>\r\n            <div className=\"channel-desc text-xs text-muted\">{channel.description}</div>\r\n            <div className=\"channel-count text-xs text-muted mt-1\">\r\n              {channel.message_count} 条消息\r\n            </div>\r\n          </button>\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\ChannelView.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadMessages'. Either include it or remove the dependency array.","line":41,"column":6,"nodeType":"ArrayExpression","endLine":41,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [channelId, loadMessages]","fix":{"range":[1483,1494],"text":"[channelId, loadMessages]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadMessages'. Either include it or remove the dependency array.","line":51,"column":6,"nodeType":"ArrayExpression","endLine":51,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [channelId, loadMessages]","fix":{"range":[1706,1717],"text":"[channelId, loadMessages]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":117,"column":21,"nodeType":"JSXOpeningElement","endLine":121,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿\"use client\";\r\n\r\nimport { useEffect, useRef, useState } from \"react\";\r\nimport { getThumbnailUrl } from \"@/utils/url\";\r\nimport * as channelService from \"@/services/channelService\";\r\n\r\nexport default function ChannelView({ channelId }: { channelId: string | number | null }) {\r\n  const [messages, setMessages] = useState<any[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [newMessage, setNewMessage] = useState(\"\");\r\n  const [sending, setSending] = useState(false);\r\n  const messagesEndRef = useRef<HTMLDivElement | null>(null);\r\n  const messagesContainerRef = useRef<HTMLDivElement | null>(null);\r\n  const token = typeof window !== \"undefined\" ? localStorage.getItem(\"token\") : null;\r\n  const [profile, setProfile] = useState<any>(() => {\r\n    try {\r\n      return JSON.parse(localStorage.getItem(\"profile\") || \"{}\");\r\n    } catch {\r\n      return {};\r\n    }\r\n  });\r\n\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    const handler = (event: Event) => {\r\n      const custom = event as CustomEvent;\r\n      if (custom?.detail) {\r\n        setProfile(custom.detail);\r\n      } else {\r\n        try {\r\n          setProfile(JSON.parse(localStorage.getItem(\"profile\") || \"{}\"));\r\n        } catch {}\r\n      }\r\n      if (channelId) {\r\n        loadMessages(true);\r\n      }\r\n    };\r\n    window.addEventListener(\"profile-updated\", handler as EventListener);\r\n    return () => window.removeEventListener(\"profile-updated\", handler as EventListener);\r\n  }, [channelId]);\r\n  useEffect(() => {\r\n    if (!channelId) return;\r\n\r\n    loadMessages();\r\n    const interval = setInterval(() => {\r\n      loadMessages(true);\r\n    }, 10000);\r\n\r\n    return () => clearInterval(interval);\r\n  }, [channelId]);\r\n\r\n  const loadMessages = async (silent = false) => {\r\n    try {\r\n      if (!silent) setLoading(true);\r\n      const data = await channelService.getMessages(channelId as string | number);\r\n      setMessages(data.reverse());\r\n\r\n      if (!silent) {\r\n        setTimeout(() => scrollToBottom(), 100);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to load messages:\", error);\r\n    } finally {\r\n      if (!silent) setLoading(false);\r\n    }\r\n  };\r\n\r\n  const scrollToBottom = () => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\r\n  };\r\n\r\n  const handleSend = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!newMessage.trim() || !token || !channelId) return;\r\n\r\n    try {\r\n      setSending(true);\r\n      const message = await channelService.postMessage(channelId, newMessage.trim());\r\n      setMessages([...messages, message]);\r\n      setNewMessage(\"\");\r\n\r\n      setTimeout(scrollToBottom, 100);\r\n    } catch (error: any) {\r\n      alert(error.message);\r\n    } finally {\r\n      setSending(false);\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (messageId: string | number) => {\r\n    if (!confirm(\"确定要删除这条消息吗？\")) return;\r\n\r\n    try {\r\n      await channelService.deleteMessage(messageId);\r\n      setMessages(messages.filter((m) => m.id !== messageId));\r\n    } catch (error: any) {\r\n      alert(error.message);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"channel-view\">\r\n      <div className=\"messages-container\" ref={messagesContainerRef}>\r\n        {messages.length === 0 ? (\r\n          <div className=\"text-center py-8 text-muted\">暂无消息，发送第一条消息吧！</div>\r\n        ) : (\r\n          messages.map((message) => (\r\n            <div key={message.id} className=\"message-item\">\r\n              <div className=\"message-header\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  {message.user_avatar ? (\r\n                    <img\r\n                      src={getThumbnailUrl(message.user_avatar, 64)}\r\n                      alt={message.username}\r\n                      className=\"w-8 h-8 rounded-full\"\r\n                    />\r\n                  ) : (\r\n                    <div className=\"avatar-fallback w-8 h-8 flex items-center justify-center rounded-full bg-secondary text-xs\">\r\n                      {message.username?.[0] || \"U\"}\r\n                    </div>\r\n                  )}\r\n                  <span className=\"font-medium text-sm\">{message.username}</span>\r\n                  <span className=\"text-xs text-muted\">\r\n                    {new Date(message.created_at).toLocaleString()}\r\n                  </span>\r\n                </div>\r\n                {profile.username === \"witw\" && (\r\n                  <button\r\n                    onClick={() => handleDelete(message.id)}\r\n                    className=\"btn-ghost btn-sm text-accent\"\r\n                  >\r\n                    删除\r\n                  </button>\r\n                )}\r\n              </div>\r\n              <div className=\"message-content\">{message.content}</div>\r\n            </div>\r\n          ))\r\n        )}\r\n        <div ref={messagesEndRef} />\r\n      </div>\r\n\r\n      {token ? (\r\n        <form onSubmit={handleSend} className=\"message-input-form\">\r\n          <textarea\r\n            value={newMessage}\r\n            onChange={(e) => setNewMessage(e.target.value)}\r\n            placeholder=\"输入消息... (Enter 发送，Shift+Enter 换行)\"\r\n            className=\"message-input\"\r\n            rows={3}\r\n            onKeyDown={(e) => {\r\n              if (e.key === \"Enter\" && !e.shiftKey) {\r\n                e.preventDefault();\r\n                handleSend(e);\r\n              }\r\n            }}\r\n          />\r\n          <button\r\n            type=\"submit\"\r\n            disabled={sending || !newMessage.trim()}\r\n            className=\"btn-primary\"\r\n          >\r\n            {sending ? \"发送中...\" : \"发送\"}\r\n          </button>\r\n        </form>\r\n      ) : (\r\n        <div className=\"text-center py-4 text-muted\">\r\n          请先<a href=\"/login\" className=\"text-accent\">登录</a>后发言\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\FavoritesPage.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\code\\witweb\\web\\src\\components\\legacy\\FavoritesPage.tsx:75:5\n  73 |\n  74 |   useEffect(() => {\n> 75 |     loadFavorites();\n     |     ^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  76 |   }, [page, router, cacheKeySignature]);\n  77 |\n  78 |   useEffect(() => {","line":75,"column":5,"nodeType":null,"endLine":75,"endColumn":18},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadFavorites'. Either include it or remove the dependency array.","line":76,"column":6,"nodeType":"ArrayExpression","endLine":76,"endColumn":39,"suggestions":[{"desc":"Update the dependencies array to be: [page, router, cacheKeySignature, loadFavorites]","fix":{"range":[2445,2478],"text":"[page, router, cacheKeySignature, loadFavorites]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadFavorites'. Either include it or remove the dependency array.","line":93,"column":6,"nodeType":"ArrayExpression","endLine":93,"endColumn":31,"suggestions":[{"desc":"Update the dependencies array to be: [page, cacheKeySignature, loadFavorites]","fix":{"range":[3156,3181],"text":"[page, cacheKeySignature, loadFavorites]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport PostCard from \"@/components/legacy/PostCard\";\r\nimport { clearAllCaches, getFavoritesCache, setFavoritesCache } from \"@/utils/memoryStore\";\r\nimport { getCachedJson, setCachedJson } from \"@/utils/cache\";\r\nimport * as blogService from \"@/services/blogService\";\r\n\r\nexport default function FavoritesPage() {\r\n  const [items, setItems] = useState<any[]>([]);\r\n  const [status, setStatus] = useState(\"loading\");\r\n  const [page, setPage] = useState(1);\r\n  const [total, setTotal] = useState(0);\r\n  const pageSize = 10;\r\n  const router = useRouter();\r\n  const profile = (() => {\r\n    try {\r\n      return JSON.parse(localStorage.getItem(\"profile\") || \"\");\r\n    } catch {\r\n      return null;\r\n    }\r\n  })();\r\n  const token = typeof window !== \"undefined\" ? localStorage.getItem(\"token\") : null;\r\n  const cacheUserKeys = [profile?.username, token, \"anon\"].filter(Boolean);\r\n  const cacheKeySignature = cacheUserKeys.join(\"|\");\r\n  const localCacheKeys = cacheUserKeys.map((key) => `cache:favorites:${key}:${page}`);\r\n\r\n  const loadFavorites = () => {\r\n    const authToken = localStorage.getItem(\"token\");\r\n    if (!authToken) {\r\n      router.push(\"/login\");\r\n      return;\r\n    }\r\n    let cached: any = null;\r\n    for (const key of cacheUserKeys) {\r\n      cached = getFavoritesCache(`${key}:${page}`);\r\n      if (cached) break;\r\n    }\r\n    if (!cached) {\r\n      for (const key of localCacheKeys) {\r\n        cached = getCachedJson(key);\r\n        if (cached) break;\r\n      }\r\n    }\r\n    if (cached) {\r\n      setItems(Array.isArray(cached.items) ? cached.items : []);\r\n      setTotal(cached.total || 0);\r\n      setStatus(\"ready\");\r\n      return;\r\n    }\r\n    setStatus(\"loading\");\r\n    blogService\r\n      .getFavorites(page, pageSize)\r\n      .then((data: any) => {\r\n        const payload = {\r\n          items: Array.isArray(data.items) ? data.items : [],\r\n          total: data.total || 0,\r\n        };\r\n        setItems(payload.items);\r\n        setTotal(payload.total);\r\n        cacheUserKeys.forEach((key) => {\r\n          setFavoritesCache(`${key}:${page}`, payload);\r\n        });\r\n        localCacheKeys.forEach((key) => {\r\n          setCachedJson(key, payload);\r\n        });\r\n        setStatus(\"ready\");\r\n      })\r\n      .catch(() => setStatus(\"error\"));\r\n  };\r\n\r\n  useEffect(() => {\r\n    loadFavorites();\r\n  }, [page, router, cacheKeySignature]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    const handler = () => {\r\n      clearAllCaches();\r\n      try {\r\n        Object.keys(localStorage).forEach((key) => {\r\n          if (key.startsWith(\"cache:blog:\") || key.startsWith(\"cache:post:\") || key.startsWith(\"cache:comments:\") || key.startsWith(\"cache:favorites:\") || key.startsWith(\"cache:profile:\")) {\r\n            localStorage.removeItem(key);\r\n          }\r\n        });\r\n      } catch {}\r\n      loadFavorites();\r\n    };\r\n    window.addEventListener(\"profile-updated\", handler as EventListener);\r\n    return () => window.removeEventListener(\"profile-updated\", handler as EventListener);\r\n  }, [page, cacheKeySignature]);\r\n\r\n  const totalPages = Math.max(1, Math.ceil(total / pageSize));\r\n\r\n  return (\r\n    <div className=\"container py-8\">\r\n      <div className=\"page-header mb-8\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold mb-2\">我的收藏</h1>\r\n          <p className=\"text-muted\">您收藏的精彩内容</p>\r\n        </div>\r\n        <div className=\"actions\">\r\n          <Link className=\"btn-ghost\" href=\"/\">\r\n            返回主页\r\n          </Link>\r\n        </div>\r\n      </div>\r\n      {status === \"error\" && <p>加载失败，请稍后再试。</p>}\r\n      {status === \"ready\" && items.length === 0 && <p>暂无收藏。</p>}\r\n      <div className=\"list grid\">\r\n        {items.map((post) => (\r\n          <PostCard key={post.slug} post={post} />\r\n        ))}\r\n      </div>\r\n      {totalPages > 1 && (\r\n        <div className=\"pagination flex items-center justify-center gap-4 mt-8\">\r\n          <button\r\n            className=\"btn-ghost\"\r\n            type=\"button\"\r\n            onClick={() => setPage((p) => Math.max(1, p - 1))}\r\n            disabled={page === 1}\r\n          >\r\n            上一页\r\n          </button>\r\n          <span className=\"text-muted text-sm\">\r\n            第 {page} / {totalPages} 页\r\n          </span>\r\n          <button\r\n            className=\"btn-ghost\"\r\n            type=\"button\"\r\n            onClick={() => setPage((p) => Math.min(totalPages, p + 1))}\r\n            disabled={page === totalPages}\r\n          >\r\n            下一页\r\n          </button>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\ForumPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\PostCard.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":32,"column":13,"nodeType":"JSXOpeningElement","endLine":38,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿\"use client\";\n\nimport Link from \"next/link\";\nimport { getThumbnailUrl } from \"@/utils/url\";\nimport { ThumbsUpIcon, MessageCircleIcon, BookmarkIcon } from \"@/components/Icons\";\n\nexport default function PostCard({\n  post,\n  showActions = false,\n  onLike,\n  onDislike,\n  onFavorite,\n  onDelete,\n  canEdit = false,\n}: {\n  post: any;\n  showActions?: boolean;\n  onLike?: (post: any) => void;\n  onDislike?: (post: any) => void;\n  onFavorite?: (post: any) => void;\n  onDelete?: (post: any) => void;\n  canEdit?: boolean;\n}) {\n  const tagList = (post.tags || \"\").split(\",\").filter(Boolean).map((t: string) => t.trim());\n  const avatarUrl = getThumbnailUrl(post.author_avatar, 64);\n\n  return (\n    <Link href={`/post/${post.slug}`} className=\"post-card\">\n      <div className=\"card-head flex justify-between items-start mb-2\">\n        <div className=\"author flex items-center gap-2\">\n          {post.author_avatar ? (\n            <img\n              src={avatarUrl}\n              alt={post.author_name || post.author}\n              loading=\"lazy\"\n              decoding=\"async\"\n              className=\"w-6 h-6 rounded-full\"\n            />\n          ) : (\n            <div className=\"avatar-fallback w-6 h-6 flex items-center justify-center rounded-full bg-secondary text-xs\">\n              {(post.author_name || post.author || \"U\")?.[0]}\n            </div>\n          )}\n          <span className=\"text-sm font-medium\">{post.author_name || post.author || \"匿名\"}</span>\n        </div>\n        <span className=\"text-xs text-muted\">{new Date(post.created_at).toLocaleString()}</span>\n      </div>\n\n      <h2 className=\"text-xl font-bold mb-2 leading-tight\">{post.title}</h2>\n\n      <p className=\"excerpt text-muted text-sm mb-4 line-clamp-2 leading-relaxed\">\n        {(post.content || \"\").replace(/\\s+/g, \" \").trim().slice(0, 140)}\n      </p>\n\n      <div className=\"post-card-footer flex justify-between items-center mt-auto\">\n        <div className=\"tag-list\">\n          {tagList.slice(0, 3).map((tag: string) => (\n            <span key={tag} className=\"tag-pill\">#{tag}</span>\n          ))}\n        </div>\n\n        {showActions ? (\n          <div className=\"post-card-actions flex gap-1\">\n            {onLike && (\n              <button\n                className=\"btn-ghost btn-sm\"\n                type=\"button\"\n                onClick={(e) => {\n                  e.preventDefault();\n                  onLike(post);\n                }}\n              >\n                <ThumbsUpIcon className=\"inline\" /> {post.like_count ?? 0}\n              </button>\n            )}\n            {onDislike && (\n              <button\n                className=\"btn-ghost btn-sm\"\n                type=\"button\"\n                onClick={(e) => {\n                  e.preventDefault();\n                  onDislike(post);\n                }}\n              >\n                <ThumbsUpIcon className=\"inline\" /> {post.dislike_count ?? 0}\n              </button>\n            )}\n            {onFavorite && (\n              <button\n                className={`btn-ghost btn-sm ${post.favorited_by_me ? \"text-accent\" : \"\"}`}\n                type=\"button\"\n                onClick={(e) => {\n                  e.preventDefault();\n                  onFavorite(post);\n                }}\n              >\n                <BookmarkIcon filled={post.favorited_by_me} className=\"inline\" /> {post.favorite_count ?? 0}\n              </button>\n            )}\n            {canEdit && onDelete && (\n              <button\n                className=\"btn-ghost btn-sm text-accent\"\n                type=\"button\"\n                onClick={(e) => {\n                  e.preventDefault();\n                  onDelete(post);\n                }}\n              >\n                删除\n              </button>\n            )}\n          </div>\n        ) : (\n          <div className=\"post-card-actions flex gap-1\">\n            <span className=\"text-sm text-muted flex items-center gap-1\">\n              <ThumbsUpIcon className=\"inline\" /> {post.like_count ?? 0}\n            </span>\n            <span className=\"text-sm text-muted flex items-center gap-1\">\n              <MessageCircleIcon className=\"inline\" /> {post.comment_count ?? 0}\n            </span>\n            <span className=\"text-sm text-muted flex items-center gap-1\">\n              <BookmarkIcon className=\"inline\" /> {post.favorite_count ?? 0}\n            </span>\n          </div>\n        )}\n      </div>\n    </Link>\n  );\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\ProfilePage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleSave'. Either include it or remove the dependency array.","line":206,"column":6,"nodeType":"ArrayExpression","endLine":206,"endColumn":29,"suggestions":[{"desc":"Update the dependencies array to be: [bio, handleSave, resolvedUsername]","fix":{"range":[6809,6832],"text":"[bio, handleSave, resolvedUsername]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleSave'. Either include it or remove the dependency array.","line":216,"column":6,"nodeType":"ArrayExpression","endLine":216,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [handleSave, nickname, resolvedUsername]","fix":{"range":[7176,7204],"text":"[handleSave, nickname, resolvedUsername]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadActivity', 'loadCounts', 'loadFavorites', 'loadPosts', and 'resolvedUsername'. Either include them or remove the dependency array.","line":291,"column":6,"nodeType":"ArrayExpression","endLine":291,"endColumn":33,"suggestions":[{"desc":"Update the dependencies array to be: [user.username, activeTab, resolvedUsername, loadCounts, loadPosts, loadFavorites, loadActivity]","fix":{"range":[9273,9300],"text":"[user.username, activeTab, resolvedUsername, loadCounts, loadPosts, loadFavorites, loadActivity]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":338,"column":19,"nodeType":"JSXOpeningElement","endLine":338,"endColumn":86}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { useAuth } from \"@/app/providers\";\r\nimport { resizeImageFile, resizeImageToDataUrl } from \"@/utils/image\";\r\nimport { getThumbnailUrl } from \"@/utils/url\";\r\nimport { clearAllCaches } from \"@/utils/memoryStore\";\r\n\r\ntype PostItem = {\r\n  title: string;\r\n  slug: string;\r\n  content?: string;\r\n  created_at?: string;\r\n  tags?: string;\r\n  like_count?: number;\r\n  comment_count?: number;\r\n  favorite_count?: number;\r\n};\r\n\r\ntype ActivityItem = {\r\n  id: string;\r\n  title: string;\r\n  created_at?: string;\r\n};\r\n\r\nfunction formatDate(value?: string) {\r\n  if (!value) return \"--\";\r\n  const date = new Date(value);\r\n  if (Number.isNaN(date.getTime())) return value;\r\n  return date.toLocaleString(\"zh-CN\", { hour12: false });\r\n}\r\n\r\nfunction buildExcerpt(content?: string) {\r\n  if (!content) return \"\";\r\n  return content\r\n    .replace(/[#>*`]/g, \"\")\r\n    .replace(/\\s+/g, \" \")\r\n    .trim()\r\n    .slice(0, 120);\r\n}\r\n\r\nexport default function ProfilePage() {\r\n  const { user, updateProfile } = useAuth();\r\n  const [nickname, setNickname] = useState(\"\");\r\n  const [avatarUrl, setAvatarUrl] = useState(\"\");\r\n  const [previewAvatar, setPreviewAvatar] = useState(\"\");\r\n  const [coverUrl, setCoverUrl] = useState(\"\");\r\n  const [coverPreview, setCoverPreview] = useState(\"\");\r\n  const [coverUploading, setCoverUploading] = useState(false);\r\n  const [bio, setBio] = useState(\"\");\r\n  const [status, setStatus] = useState<\"\" | \"saving\" | \"success\" | \"error\">(\"\");\r\n  const [activeTab, setActiveTab] = useState<\"posts\" | \"activity\" | \"favorites\">(\"posts\");\r\n  const [posts, setPosts] = useState<PostItem[]>([]);\r\n  const [favorites, setFavorites] = useState<PostItem[]>([]);\r\n  const [activity, setActivity] = useState<ActivityItem[]>([]);\r\n  const [tabLoading, setTabLoading] = useState(false);\r\n\r\n  const resolvedUsername = useMemo(() => {\r\n    if (user?.username) return user.username;\r\n    if (typeof window === \"undefined\") return \"\";\r\n    try {\r\n      const raw = localStorage.getItem(\"profile\");\r\n      if (!raw) return \"\";\r\n      const data = JSON.parse(raw);\r\n      return data?.username || \"\";\r\n    } catch {\r\n      return \"\";\r\n    }\r\n  }, [user?.username]);\r\n  const fileInputRef = useRef<HTMLInputElement | null>(null);\r\n  const coverInputRef = useRef<HTMLInputElement | null>(null);\r\n\r\n  const avatarBase = previewAvatar || user?.avatar_url || \"\";\r\n  const avatarSrc = avatarBase\r\n    ? (avatarBase.startsWith(\"data:\") ? avatarBase : getThumbnailUrl(avatarBase, 256))\r\n    : \"\";\r\n\r\n  const coverBase = coverPreview || user?.cover_url || \"\";\r\n  const coverSrc = coverBase\r\n    ? (coverBase.startsWith(\"data:\") ? coverBase : getThumbnailUrl(coverBase, 1600))\r\n    : \"\";\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      setNickname(user.nickname || user.username || \"\");\r\n      setAvatarUrl(user.avatar_url || \"\");\r\n      setPreviewAvatar(user.avatar_url || \"\");\r\n      setCoverUrl(user.cover_url || \"\");\r\n      setCoverPreview(user.cover_url || \"\");\r\n      setBio((user as any)?.bio || \"\");\r\n      return;\r\n    }\r\n    if (typeof window === \"undefined\") return;\r\n    try {\r\n      const raw = localStorage.getItem(\"profile\");\r\n      if (!raw) return;\r\n      const data = JSON.parse(raw);\r\n      setNickname(data?.nickname || data?.username || \"\");\r\n      setAvatarUrl(data?.avatar_url || \"\");\r\n      setPreviewAvatar(data?.avatar_url || \"\");\r\n      setCoverUrl(data?.cover_url || \"\");\r\n      setCoverPreview(data?.cover_url || \"\");\r\n      setBio(data?.bio || \"\");\r\n    } catch {\r\n      return;\r\n    }\r\n  }, [user]);\r\n\r\n  async function handleAvatarChange(event: React.ChangeEvent<HTMLInputElement>) {\r\n    const file = event.target.files?.[0];\r\n    if (!file) return;\r\n    const resized = await resizeImageToDataUrl(file, 256);\r\n    setAvatarUrl(resized || \"\");\r\n    setPreviewAvatar(resized || \"\");\r\n    setTimeout(() => handleSave(undefined, true), 0);\r\n  }\r\n\r\n  async function uploadCover(file: File) {\r\n    const token = localStorage.getItem(\"token\");\r\n    if (!token) throw new Error(\"missing_token\");\r\n    const resized = await resizeImageFile(file, 1600);\r\n    const form = new FormData();\r\n    form.append(\"file\", resized, resized.name || \"cover.jpg\");\r\n    const res = await fetch(\"/api/upload-image\", {\r\n      method: \"POST\",\r\n      headers: { Authorization: `Bearer ${token}` },\r\n      body: form,\r\n    });\r\n    const data = await res.json().catch(() => ({}));\r\n    if (!res.ok || !data?.url) throw new Error(\"upload_failed\");\r\n    return data.url as string;\r\n  }\r\n\r\n  async function handleCoverChange(event: React.ChangeEvent<HTMLInputElement>) {\r\n    const file = event.target.files?.[0];\r\n    if (!file) return;\r\n    setCoverUploading(true);\r\n    try {\r\n      const url = await uploadCover(file);\r\n      setCoverUrl(url);\r\n      setCoverPreview(url);\r\n      await handleSave(url);\r\n    } catch {\r\n      setStatus(\"error\");\r\n    } finally {\r\n      setCoverUploading(false);\r\n    }\r\n  }\r\n\r\n  async function handleSave(nextCover?: string, silent: boolean = false) {\r\n    if (!silent) setStatus(\"saving\");\r\n    try {\r\n      const token = localStorage.getItem(\"token\");\r\n      if (!token) {\r\n        setStatus(\"error\");\r\n        return;\r\n      }\r\n      const res = await fetch(\"/api/profile\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n        body: JSON.stringify({\r\n          nickname,\r\n          avatar_url: avatarUrl,\r\n          cover_url: typeof nextCover === \"string\" ? nextCover : coverUrl,\r\n          bio,\r\n        }),\r\n      });\r\n      if (!res.ok) {\r\n        if (!silent) setStatus(\"error\");\r\n        return;\r\n      }\r\n      const data = await res.json();\r\n      if (data.profile) {\r\n        updateProfile(data.profile);\r\n      }\r\n      clearAllCaches();\r\n      try {\r\n        const ts = Date.now().toString();\r\n        localStorage.setItem(\"profile_updated_at\", ts);\r\n        window.dispatchEvent(new CustomEvent(\"profile-updated\", { detail: { ...data.profile, updated_at: ts } }));\r\n      } catch {}\r\n      setStatus(\"success\");\r\n      setTimeout(() => setStatus(\"\"), 2000);\r\n    } catch {\r\n      setStatus(\"error\");\r\n    }\r\n  }\r\n\r\n  const lastSavedBioRef = useRef<string>(\"\");\r\n  const bioSaveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n\r\n  const lastSavedNameRef = useRef<string>(\"\");\r\n  const nameSaveTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n\r\n  useEffect(() => {\r\n    if (!resolvedUsername) return;\r\n    if (bioSaveTimerRef.current) clearTimeout(bioSaveTimerRef.current);\r\n    if (bio === lastSavedBioRef.current) return;\r\n    bioSaveTimerRef.current = setTimeout(() => {\r\n      lastSavedBioRef.current = bio;\r\n      handleSave(undefined, true);\r\n    }, 800);\r\n  }, [bio, resolvedUsername]);\r\n\r\n  useEffect(() => {\r\n    if (!resolvedUsername) return;\r\n    if (nameSaveTimerRef.current) clearTimeout(nameSaveTimerRef.current);\r\n    if (nickname === lastSavedNameRef.current) return;\r\n    nameSaveTimerRef.current = setTimeout(() => {\r\n      lastSavedNameRef.current = nickname;\r\n      handleSave(undefined, true);\r\n    }, 800);\r\n  }, [nickname, resolvedUsername]);\r\n\r\n  const safeJson = async (res: Response) => {\r\n    if (!res.ok) throw new Error(\"http_error\");\r\n    const text = await res.text();\r\n    if (!text) return {} as any;\r\n    try {\r\n      return JSON.parse(text);\r\n    } catch {\r\n      return {} as any;\r\n    }\r\n  };\r\n\r\n  const loadPosts = async (silent = false) => {\r\n    if (!resolvedUsername) return [] as PostItem[];\r\n    if (!silent) setTabLoading(true);\r\n    try {\r\n      const res = await fetch(`/api/blog?author=${encodeURIComponent(resolvedUsername)}&page=1&size=12`);\r\n      const data = await safeJson(res);\r\n      const items = data.items || [];\r\n      setPosts(items);\r\n      return items as PostItem[];\r\n    } catch {\r\n      setPosts([]);\r\n      return [] as PostItem[];\r\n    } finally {\r\n      if (!silent) setTabLoading(false);\r\n    }\r\n  };\r\n\r\n  const loadFavorites = async (silent = false) => {\r\n    if (!silent) setTabLoading(true);\r\n    try {\r\n      const token = localStorage.getItem(\"token\");\r\n      const res = await fetch(\"/api/favorites?page=1&size=12\", {\r\n        headers: token ? { Authorization: `Bearer ${token}` } : {},\r\n      });\r\n      const data = await safeJson(res);\r\n      setFavorites(data.items || []);\r\n    } catch {\r\n      setFavorites([]);\r\n    } finally {\r\n      if (!silent) setTabLoading(false);\r\n    }\r\n  };\r\n\r\n  const loadActivity = async (silent = false) => {\r\n    if (!resolvedUsername) return;\r\n    if (!silent) setTabLoading(true);\r\n    try {\r\n      let items = posts;\r\n      if (items.length == 0) {\r\n        items = await loadPosts(true);\r\n      }\r\n      const activityItems = (items || []).map((post) => ({\r\n        id: post.slug,\r\n        title: post.title,\r\n        created_at: post.created_at,\r\n      }));\r\n      setActivity(activityItems);\r\n    } finally {\r\n      if (!silent) setTabLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (!resolvedUsername) return;\r\n    loadCounts();\r\n    if (activeTab === \"posts\") {\r\n      loadPosts();\r\n    } else if (activeTab === \"favorites\") {\r\n      loadFavorites();\r\n    } else {\r\n      loadActivity();\r\n    }\r\n  }, [user?.username, activeTab]);\r\n\r\n  const loadCounts = async () => {\r\n    if (!resolvedUsername) return;\r\n    try {\r\n      const res = await fetch(`/api/users/${encodeURIComponent(user.username)}/profile`);\r\n      const data = await safeJson(res);\r\n      if (data && !data.__error) {\r\n        updateProfile({ ...(user || {}), ...data });\r\n      }\r\n    } catch {\r\n      return;\r\n    }\r\n  };\r\n\r\n  const likeSum = useMemo(() => posts.reduce((sum, item) => sum + (item.like_count || 0), 0), [posts]);\r\n\r\n  const following = user?.following_count ?? 0;\r\n  const follower = user?.follower_count ?? 0;\r\n  const likes = likeSum;\r\n\r\n  return (\r\n    <div className=\"profile-page profile-page--view\">\r\n      <div className=\"profile-shell\">\r\n        <section className=\"profile-cover\" style={coverSrc ? { backgroundImage: `url(${coverSrc})` } : undefined}>\r\n          <button\r\n            className=\"profile-cover-btn\"\r\n            type=\"button\"\r\n            onClick={() => coverInputRef.current?.click()}\r\n            disabled={coverUploading}\r\n          >\r\n            {coverUploading ? \"\\u4e0a\\u4f20\\u4e2d...\" : \"\\u66f4\\u6362\\u5c01\\u9762\"}\r\n          </button>\r\n          <input\r\n            type=\"file\"\r\n            ref={coverInputRef}\r\n            className=\"hidden\"\r\n            accept=\"image/*\"\r\n            onChange={handleCoverChange}\r\n          />\r\n        </section>\r\n\r\n        <section className=\"profile-hero-row\">\r\n          <div className=\"profile-hero-card\">\r\n            <div className=\"profile-identity\">\r\n              <div className=\"profile-avatar\">\r\n                {(previewAvatar || user?.avatar_url) ? (\r\n                  <img src={avatarSrc} alt=\"Avatar\" className=\"profile-avatar-img\" />\r\n                ) : (\r\n                  <div className=\"profile-avatar-fallback\">\r\n                    {user?.username?.[0]?.toUpperCase()}\r\n                  </div>\r\n                )}\r\n                <label className=\"profile-avatar-mask\" style={{ cursor: \"pointer\" }}>\r\n                  {\"\\u66f4\\u6362\\u5934\\u50cf\"}\r\n                  <input\r\n                    type=\"file\"\r\n                    ref={fileInputRef}\r\n                    className=\"hidden\"\r\n                    accept=\"image/*\"\r\n                    onChange={handleAvatarChange}\r\n                  />\r\n                </label>\r\n              </div>\r\n              <div className=\"profile-identity-text\">\r\n                <input\r\n                  className=\"profile-name-input\"\r\n                  value={nickname}\r\n                  onChange={(e) => setNickname(e.target.value)}\r\n                  placeholder={\"\\u8bf7\\u8f93\\u5165\\u6635\\u79f0\"}\r\n                />\r\n                <div className=\"profile-handle\">@{resolvedUsername || user?.username || \"--\"}</div>\r\n                <input\r\n                  className=\"profile-bio-input\"\r\n                  value={bio}\r\n                  onChange={(e) => setBio(e.target.value)}\r\n                  placeholder={\"\\u8bf7\\u8f93\\u5165\\u7b80\\u4ecb\"}\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </section>\r\n\r\n        <section className=\"profile-tabs-row\">\r\n          <div className=\"profile-tabs\">\r\n            <button className={`profile-tab ${activeTab === \"posts\" ? \"is-active\" : \"\"}`} onClick={() => setActiveTab(\"posts\")}>\r\n              {\"\\u6587\\u7ae0\"}\r\n            </button>\r\n            <button className={`profile-tab ${activeTab === \"activity\" ? \"is-active\" : \"\"}`} onClick={() => setActiveTab(\"activity\")}>\r\n              {\"\\u52a8\\u6001\"}\r\n            </button>\r\n            <button className={`profile-tab ${activeTab === \"favorites\" ? \"is-active\" : \"\"}`} onClick={() => setActiveTab(\"favorites\")}>\r\n              {\"\\u6536\\u85cf\"}\r\n            </button>\r\n          </div>\r\n          <div className=\"profile-stats\">\r\n            <div className=\"profile-stat\">\r\n              <div className=\"profile-stat-label\">{\"\\u5173\\u6ce8\\u6570\"}</div>\r\n              <div className=\"profile-stat-value\">{following}</div>\r\n            </div>\r\n            <div className=\"profile-stat\">\r\n              <div className=\"profile-stat-label\">{\"\\u7c89\\u4e1d\\u6570\"}</div>\r\n              <div className=\"profile-stat-value\">{follower}</div>\r\n            </div>\r\n            <div className=\"profile-stat\">\r\n              <div className=\"profile-stat-label\">{\"\\u83b7\\u8d5e\\u6570\"}</div>\r\n              <div className=\"profile-stat-value\">{likes}</div>\r\n            </div>\r\n          </div>\r\n        </section>\r\n\r\n        <section className=\"profile-main\">\r\n          <div className=\"profile-feed\">\r\n            <div className=\"profile-feed-title\">\r\n              {activeTab === \"posts\" ? \"\\u6587\\u7ae0\" : activeTab === \"activity\" ? \"\\u52a8\\u6001\" : \"\\u6536\\u85cf\"}\r\n            </div>\r\n            {tabLoading && <div className=\"profile-feed-empty\">{\"\\u52a0\\u8f7d\\u4e2d...\"}</div>}\r\n            {!tabLoading && activeTab === \"posts\" && (\r\n              <div className=\"profile-feed-list\">\r\n                {posts.length === 0 ? (\r\n                  <div className=\"profile-feed-empty\">{\"\\u6682\\u65e0\\u6587\\u7ae0\"}</div>\r\n                ) : (\r\n                  posts.map((post) => (\r\n                    <div className=\"profile-feed-card\" key={post.slug}>\r\n                      <div className=\"profile-card-title\">{post.title}</div>\r\n                      {post.content && <div className=\"profile-card-excerpt\">{buildExcerpt(post.content)}</div>}\r\n                      <div className=\"profile-card-meta\">\r\n                        <span>{formatDate(post.created_at)}</span>\r\n                        <span>Like {post.like_count || 0}</span>\r\n                        <span>Comment {post.comment_count || 0}</span>\r\n                        <span>Fav {post.favorite_count || 0}</span>\r\n                      </div>\r\n                    </div>\r\n                  ))\r\n                )}\r\n              </div>\r\n            )}\r\n            {!tabLoading && activeTab === \"favorites\" && (\r\n              <div className=\"profile-feed-list\">\r\n                {favorites.length === 0 ? (\r\n                  <div className=\"profile-feed-empty\">{\"\\u6682\\u65e0\\u6536\\u85cf\"}</div>\r\n                ) : (\r\n                  favorites.map((post) => (\r\n                    <div className=\"profile-feed-card\" key={post.slug}>\r\n                      <div className=\"profile-card-title\">{post.title}</div>\r\n                      {post.content && <div className=\"profile-card-excerpt\">{buildExcerpt(post.content)}</div>}\r\n                      <div className=\"profile-card-meta\">\r\n                        <span>{formatDate(post.created_at)}</span>\r\n                        <span>Like {post.like_count || 0}</span>\r\n                        <span>Comment {post.comment_count || 0}</span>\r\n                        <span>Fav {post.favorite_count || 0}</span>\r\n                      </div>\r\n                    </div>\r\n                  ))\r\n                )}\r\n              </div>\r\n            )}\r\n            {!tabLoading && activeTab === \"activity\" && (\r\n              <div className=\"profile-feed-list\">\r\n                {activity.length === 0 ? (\r\n                  <div className=\"profile-feed-empty\">{\"\\u6682\\u65e0\\u52a8\\u6001\"}</div>\r\n                ) : (\r\n                  activity.map((item) => (\r\n                    <div className=\"profile-feed-card\" key={item.id}>\r\n                      <div className=\"profile-card-title\">{`\\u53d1\\u5e03\\u6587\\u7ae0\\u300a${item.title}\\u300b`}</div>\r\n                      <div className=\"profile-card-meta\">\r\n                        <span>{formatDate(item.created_at)}</span>\r\n                      </div>\r\n                    </div>\r\n                  ))\r\n                )}\r\n              </div>\r\n            )}\r\n          </div>\r\n          <aside className=\"profile-side\">\r\n            <div className=\"profile-side-card\">\r\n              <h3>{\"\\u4e2a\\u4eba\\u8d44\\u6599\"}</h3>\r\n              <div className=\"profile-side-row\">\r\n                <span>UID</span>\r\n                <span>{resolvedUsername || user?.username || \"--\"}</span>\r\n              </div>\r\n              <div className=\"profile-side-row\">\r\n                <span>{\"\\u6ce8\\u518c\\u65f6\\u95f4\"}</span>\r\n                <span>{(user as any)?.created_at || \"--\"}</span>\r\n              </div>\r\n              <p className=\"profile-side-tip\">{\"\\u70b9\\u51fb\\u5934\\u50cf\\u53ef\\u66f4\\u6362\\u5934\\u50cf\\uff0c\\u70b9\\u51fb\\u6635\\u79f0\\u53ef\\u76f4\\u63a5\\u7f16\\u8f91\\u3002\"}</p>\r\n              {status === \"success\" && <p className=\"status success\">{\"\\u4fdd\\u5b58\\u6210\\u529f\"}</p>}\r\n              {status === \"error\" && <p className=\"status error\">{\"\\u4fdd\\u5b58\\u5931\\u8d25\\uff0c\\u8bf7\\u91cd\\u8bd5\"}</p>}\r\n            </div>\r\n          </aside>\r\n        </section>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\PublishPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\RegisterPage.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":100,"column":15,"nodeType":"JSXOpeningElement","endLine":104,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿\"use client\";\n\nimport { useState } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { resizeImageToDataUrl } from \"@/utils/image\";\nimport { useAuth } from \"@/app/providers\";\n\nexport default function RegisterPage() {\n  const [username, setUsername] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [nickname, setNickname] = useState(\"\");\n  const [avatarUrl, setAvatarUrl] = useState(\"\");\n  const [error, setError] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const router = useRouter();\n  const { login } = useAuth();\n\n  async function handleAvatarChange(event: React.ChangeEvent<HTMLInputElement>) {\n    const file = event.target.files?.[0];\n    if (!file) {\n      setAvatarUrl(\"\");\n      return;\n    }\n    const resized = await resizeImageToDataUrl(file, 256);\n    setAvatarUrl(resized || \"\");\n  }\n\n  async function handleRegister(event: React.FormEvent) {\n    event.preventDefault();\n    setError(\"\");\n\n    if (!username.trim() || !password.trim()) {\n      setError(\"请输入账号和密码\");\n      return;\n    }\n\n    if (password.length < 6) {\n      setError(\"密码至少需要6位字符\");\n      return;\n    }\n\n    setLoading(true);\n    try {\n      const res = await fetch(\"/api/register\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          username,\n          password,\n          nickname,\n          avatar_url: avatarUrl,\n        }),\n      });\n      if (!res.ok) {\n        const data = await res.json().catch(() => ({}));\n        setError(data.detail || \"注册失败，请稍后重试\");\n        return;\n      }\n      const data = await res.json();\n      if (data.token && data.profile) {\n        login(data.token, data.profile);\n      }\n      router.push(\"/\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"flex flex-col items-center justify-center min-h-screen bg-primary px-4\">\n      <div className=\"text-center mb-8\">\n        <h1 className=\"text-3xl font-bold mb-2\">AI Studio</h1>\n        <p className=\"text-secondary\">注册后自动登录</p>\n      </div>\n\n      <form className=\"card form w-full max-w-md p-8 shadow-lg\" onSubmit={handleRegister}>\n        <label className=\"block mb-4\">\n          <span className=\"block mb-1 font-medium\">账号</span>\n          <input\n            className=\"input\"\n            value={username}\n            onChange={(event) => setUsername(event.target.value)}\n            placeholder=\"设置账号\"\n          />\n        </label>\n        <label className=\"block mb-4\">\n          <span className=\"block mb-1 font-medium\">昵称</span>\n          <input\n            className=\"input\"\n            value={nickname}\n            onChange={(event) => setNickname(event.target.value)}\n            placeholder=\"显示昵称\"\n          />\n        </label>\n        <label className=\"block mb-4\">\n          <span className=\"block mb-1 font-medium\">头像</span>\n          <div className=\"flex items-center gap-4\">\n            {avatarUrl && (\n              <img\n                src={avatarUrl}\n                alt=\"Avatar preview\"\n                className=\"w-16 h-16 rounded-full object-cover border-2 border-accent\"\n              />\n            )}\n            <input\n              type=\"file\"\n              accept=\"image/*\"\n              onChange={handleAvatarChange}\n              className=\"text-sm text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-accent file:text-white hover:file:bg-opacity-90 cursor-pointer\"\n            />\n          </div>\n        </label>\n        <label className=\"block mb-6\">\n          <span className=\"block mb-1 font-medium\">密码</span>\n          <input\n            className=\"input\"\n            type=\"password\"\n            value={password}\n            onChange={(event) => setPassword(event.target.value)}\n            placeholder=\"设置密码\"\n          />\n        </label>\n        {error && (\n          <p className=\"text-accent mb-4 text-sm bg-accent/10 p-3 rounded border border-accent/20\">\n            {error}\n          </p>\n        )}\n        <button className=\"btn-primary w-full justify-center\" type=\"submit\" disabled={loading}>\n          {loading ? \"注册中...\" : \"注册并登录\"}\n        </button>\n        <div className=\"mt-4 text-center\">\n          <Link className=\"btn-ghost text-sm\" href=\"/login\">\n            已有账号？直接登录\n          </Link>\n        </div>\n      </form>\n    </div>\n  );\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\admin\\AIAdminPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":28,"column":6,"nodeType":"ArrayExpression","endLine":28,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadData]","fix":{"range":[1314,1316],"text":"[loadData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\n\r\nexport default function AIAdminPage() {\r\n  const [credits, setCredits] = useState(0);\r\n  const [loading, setLoading] = useState(true);\r\n  const [apiKeys, setApiKeys] = useState<any[]>([]);\r\n  const [showCreateModal, setShowCreateModal] = useState(false);\r\n  const [modelStatuses, setModelStatuses] = useState<Record<string, any>>({});\r\n  const [tokenConfig, setTokenConfig] = useState({ has_token: false, token_preview: null as string | null });\r\n  const [showTokenInput, setShowTokenInput] = useState(false);\r\n  const [newToken, setNewToken] = useState(\"\");\r\n  const [savingToken, setSavingToken] = useState(false);\r\n\r\n  const [baseUrlConfig, setBaseUrlConfig] = useState({ base_url: \"https://grsaiapi.com\" });\r\n  const [showBaseUrlInput, setShowBaseUrlInput] = useState(false);\r\n  const [newBaseUrl, setNewBaseUrl] = useState(\"\");\r\n  const [savingBaseUrl, setSavingBaseUrl] = useState(false);\r\n\r\n  const [sora2KeyConfig, setSora2KeyConfig] = useState({ has_token: false, token_preview: null as string | null });\r\n  const [showSora2KeyInput, setShowSora2KeyInput] = useState(false);\r\n  const [newSora2Key, setNewSora2Key] = useState(\"\");\r\n  const [savingSora2Key, setSavingSora2Key] = useState(false);\r\n\r\n  useEffect(() => {\r\n    loadData();\r\n  }, []);\r\n\r\n  const loadData = async () => {\r\n    try {\r\n      setLoading(true);\r\n      await Promise.all([\r\n        loadTokenConfig(),\r\n        loadBaseUrlConfig(),\r\n        loadSora2KeyConfig(),\r\n        loadCredits(),\r\n        loadModelStatuses(),\r\n        loadApiKeys(),\r\n      ]);\r\n    } catch (error) {\r\n      console.error(\"Failed to load data:\", error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const loadTokenConfig = async () => {\r\n    const token = localStorage.getItem(\"token\");\r\n    const response = await fetch(\"/api/admin/ai/config/token\", {\r\n      headers: { Authorization: `Bearer ${token}` },\r\n    });\r\n    if (response.ok) {\r\n      const data = await response.json();\r\n      setTokenConfig(data);\r\n    }\r\n  };\r\n\r\n  const loadBaseUrlConfig = async () => {\r\n    const token = localStorage.getItem(\"token\");\r\n    const response = await fetch(\"/api/admin/ai/config/base-url\", {\r\n      headers: { Authorization: `Bearer ${token}` },\r\n    });\r\n    if (response.ok) {\r\n      const data = await response.json();\r\n      setBaseUrlConfig(data);\r\n      setNewBaseUrl(data.base_url || \"https://grsaiapi.com\");\r\n    }\r\n  };\r\n\r\n  const loadSora2KeyConfig = async () => {\r\n    const token = localStorage.getItem(\"token\");\r\n    const response = await fetch(\"/api/admin/ai/config/sora2-key\", {\r\n      headers: { Authorization: `Bearer ${token}` },\r\n    });\r\n    if (response.ok) {\r\n      const data = await response.json();\r\n      setSora2KeyConfig(data);\r\n    }\r\n  };\r\n\r\n  const loadCredits = async () => {\r\n    const token = localStorage.getItem(\"token\");\r\n    const response = await fetch(\"/api/admin/ai/credits\", {\r\n      headers: { Authorization: `Bearer ${token}` },\r\n    });\r\n    if (!response.ok) throw new Error(\"Failed to fetch credits\");\r\n    const data = await response.json();\r\n    setCredits(data.credits || 0);\r\n  };\r\n\r\n  const loadApiKeys = async () => {\r\n    const token = localStorage.getItem(\"token\");\r\n    const response = await fetch(\"/api/admin/ai/apikeys\", {\r\n      headers: { Authorization: `Bearer ${token}` },\r\n    });\r\n    if (response.ok) {\r\n      const data = await response.json();\r\n      setApiKeys(data.data || data.items || []);\r\n    }\r\n  };\r\n\r\n  const loadModelStatuses = async () => {\r\n    const models = [\"gpt-4\", \"gpt-3.5-turbo\", \"claude-3-opus\", \"claude-3-sonnet\"];\r\n    const token = localStorage.getItem(\"token\");\r\n    const statuses: Record<string, any> = {};\r\n    for (const model of models) {\r\n      try {\r\n        const response = await fetch(`/api/admin/ai/models/${model}/status`, {\r\n          headers: { Authorization: `Bearer ${token}` },\r\n        });\r\n        if (response.ok) {\r\n          const data = await response.json();\r\n          statuses[model] = data;\r\n        }\r\n      } catch (error) {\r\n        console.error(`Failed to load status for ${model}:`, error);\r\n      }\r\n    }\r\n    setModelStatuses(statuses);\r\n  };\r\n\r\n  const handleSaveToken = async () => {\r\n    if (!newToken.trim()) {\r\n      alert(\"请输入 API Token\");\r\n      return;\r\n    }\r\n    try {\r\n      setSavingToken(true);\r\n      const token = localStorage.getItem(\"token\");\r\n      const response = await fetch(\"/api/admin/ai/config/token\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({ token: newToken.trim() }),\r\n      });\r\n      if (!response.ok) throw new Error(\"Failed to save token\");\r\n      alert(\"API Token 保存成功\");\r\n      setNewToken(\"\");\r\n      setShowTokenInput(false);\r\n      await loadTokenConfig();\r\n      await loadCredits();\r\n    } catch (error: any) {\r\n      alert(`保存失败: ${error.message}`);\r\n    } finally {\r\n      setSavingToken(false);\r\n    }\r\n  };\r\n\r\n  const handleSaveBaseUrl = async () => {\r\n    if (!newBaseUrl.trim()) {\r\n      alert(\"请输入 API Base URL\");\r\n      return;\r\n    }\r\n    try {\r\n      setSavingBaseUrl(true);\r\n      const token = localStorage.getItem(\"token\");\r\n      const response = await fetch(\"/api/admin/ai/config/base-url\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({ base_url: newBaseUrl.trim() }),\r\n      });\r\n      if (!response.ok) throw new Error(\"Failed to save base URL\");\r\n      alert(\"API Base URL 保存成功\");\r\n      setShowBaseUrlInput(false);\r\n      await loadBaseUrlConfig();\r\n    } catch (error: any) {\r\n      alert(`保存失败: ${error.message}`);\r\n    } finally {\r\n      setSavingBaseUrl(false);\r\n    }\r\n  };\r\n\r\n  const handleSaveSora2Key = async () => {\r\n    if (!newSora2Key.trim()) {\r\n      alert(\"请输入 Sora2 API Key\");\r\n      return;\r\n    }\r\n    try {\r\n      setSavingSora2Key(true);\r\n      const token = localStorage.getItem(\"token\");\r\n      const response = await fetch(\"/api/admin/ai/config/sora2-key\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({ token: newSora2Key.trim() }),\r\n      });\r\n      if (!response.ok) throw new Error(\"Failed to save Sora2 API key\");\r\n      alert(\"Sora2 API Key 保存成功\");\r\n      setNewSora2Key(\"\");\r\n      setShowSora2KeyInput(false);\r\n      await loadSora2KeyConfig();\r\n    } catch (error: any) {\r\n      alert(`保存失败: ${error.message}`);\r\n    } finally {\r\n      setSavingSora2Key(false);\r\n    }\r\n  };\r\n\r\n  const handleCreateKey = async (formData: any) => {\r\n    try {\r\n      const token = localStorage.getItem(\"token\");\r\n      const response = await fetch(\"/api/admin/ai/apikeys\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify(formData),\r\n      });\r\n      if (!response.ok) throw new Error(\"Failed to create API key\");\r\n      const result = await response.json();\r\n      alert(`APIKey 创建成功！\\n\\nKey: ${result.data?.key || result.key || \"\"}\\n\\n请妥善保存，此密钥只显示一次！`);\r\n      setShowCreateModal(false);\r\n      loadCredits();\r\n      loadApiKeys();\r\n    } catch (error: any) {\r\n      alert(`创建失败: ${error.message}`);\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className=\"ai-admin-page\">\r\n      <div className=\"admin-header\">\r\n        <h1>AI 服务管理</h1>\r\n        <button onClick={loadData} className=\"btn-secondary\">\r\n          刷新数据\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"token-config-section card\">\r\n        <div className=\"section-header\">\r\n          <h2>API Token 配置</h2>\r\n          {!showTokenInput && (\r\n            <button onClick={() => setShowTokenInput(true)} className=\"btn-secondary\">\r\n              {tokenConfig.has_token ? \"更新 Token\" : \"设置 Token\"}\r\n            </button>\r\n          )}\r\n        </div>\r\n\r\n        {tokenConfig.has_token && !showTokenInput ? (\r\n          <div className=\"token-status\">\r\n            <span className=\"status-badge online\">已配置</span>\r\n            <code className=\"token-preview\">{tokenConfig.token_preview}</code>\r\n          </div>\r\n        ) : !showTokenInput ? (\r\n          <p className=\"text-muted\">未配置 API Token，请点击上方按钮设置</p>\r\n        ) : null}\r\n\r\n        {showTokenInput && (\r\n          <div className=\"token-input-form\">\r\n            <div className=\"form-group\">\r\n              <label>GRSAI API Token</label>\r\n              <input\r\n                type=\"password\"\r\n                value={newToken}\r\n                onChange={(e) => setNewToken(e.target.value)}\r\n                placeholder=\"请输入您的 API Token\"\r\n                className=\"token-input\"\r\n              />\r\n              <small className=\"text-muted\">\r\n                Token 将安全保存在服务端，用于调用 GRSAI API 服务\r\n              </small>\r\n            </div>\r\n            <div className=\"form-actions\">\r\n              <button\r\n                onClick={() => {\r\n                  setShowTokenInput(false);\r\n                  setNewToken(\"\");\r\n                }}\r\n                className=\"btn-secondary\"\r\n                disabled={savingToken}\r\n              >\r\n                取消\r\n              </button>\r\n              <button\r\n                onClick={handleSaveToken}\r\n                className=\"btn-primary\"\r\n                disabled={savingToken}\r\n              >\r\n                {savingToken ? \"保存中...\" : \"保存\"}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"token-config-section card\">\r\n        <div className=\"section-header\">\r\n          <h2>API Base URL 配置</h2>\r\n          {!showBaseUrlInput && (\r\n            <button onClick={() => setShowBaseUrlInput(true)} className=\"btn-secondary\">\r\n              更新 Base URL\r\n            </button>\r\n          )}\r\n        </div>\r\n\r\n        {!showBaseUrlInput ? (\r\n          <div className=\"token-status\">\r\n            <span className=\"status-badge online\">当前 URL</span>\r\n            <code className=\"token-preview\">{baseUrlConfig.base_url}</code>\r\n          </div>\r\n        ) : null}\r\n\r\n        {showBaseUrlInput && (\r\n          <div className=\"token-input-form\">\r\n            <div className=\"form-group\">\r\n              <label>GRSAI API Base URL</label>\r\n              <input\r\n                type=\"text\"\r\n                value={newBaseUrl}\r\n                onChange={(e) => setNewBaseUrl(e.target.value)}\r\n                placeholder=\"https://grsaiapi.com\"\r\n                className=\"token-input\"\r\n              />\r\n              <small className=\"text-muted\">\r\n                API 服务的基础 URL 地址，默认 https://grsaiapi.com\r\n              </small>\r\n            </div>\r\n            <div className=\"form-actions\">\r\n              <button\r\n                onClick={() => {\r\n                  setShowBaseUrlInput(false);\r\n                  setNewBaseUrl(baseUrlConfig.base_url);\r\n                }}\r\n                className=\"btn-secondary\"\r\n                disabled={savingBaseUrl}\r\n              >\r\n                取消\r\n              </button>\r\n              <button\r\n                onClick={handleSaveBaseUrl}\r\n                className=\"btn-primary\"\r\n                disabled={savingBaseUrl}\r\n              >\r\n                {savingBaseUrl ? \"保存中...\" : \"保存\"}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"token-config-section card\">\r\n        <div className=\"section-header\">\r\n          <h2>Sora2 API Key 配置</h2>\r\n          {!showSora2KeyInput && (\r\n            <button onClick={() => setShowSora2KeyInput(true)} className=\"btn-secondary\">\r\n              {sora2KeyConfig.has_token ? \"更新 API Key\" : \"设置 API Key\"}\r\n            </button>\r\n          )}\r\n        </div>\r\n\r\n        {sora2KeyConfig.has_token && !showSora2KeyInput ? (\r\n          <div className=\"token-status\">\r\n            <span className=\"status-badge online\">已配置</span>\r\n            <code className=\"token-preview\">{sora2KeyConfig.token_preview}</code>\r\n          </div>\r\n        ) : !showSora2KeyInput ? (\r\n          <p className=\"text-muted\">未配置 Sora2 API Key，请点击上方按钮设置</p>\r\n        ) : null}\r\n\r\n        {showSora2KeyInput && (\r\n          <div className=\"token-input-form\">\r\n            <div className=\"form-group\">\r\n              <label>Sora2 API Key</label>\r\n              <input\r\n                type=\"password\"\r\n                value={newSora2Key}\r\n                onChange={(e) => setNewSora2Key(e.target.value)}\r\n                placeholder=\"请输入您的 Sora2 API Key\"\r\n                className=\"token-input\"\r\n              />\r\n              <small className=\"text-muted\">用于 Sora2 视频生成服务的 API 密钥</small>\r\n            </div>\r\n            <div className=\"form-actions\">\r\n              <button\r\n                onClick={() => {\r\n                  setShowSora2KeyInput(false);\r\n                  setNewSora2Key(\"\");\r\n                }}\r\n                className=\"btn-secondary\"\r\n                disabled={savingSora2Key}\r\n              >\r\n                取消\r\n              </button>\r\n              <button\r\n                onClick={handleSaveSora2Key}\r\n                className=\"btn-primary\"\r\n                disabled={savingSora2Key}\r\n              >\r\n                {savingSora2Key ? \"保存中...\" : \"保存\"}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"balance-card\">\r\n        <div className=\"card-header\">\r\n          <h2>账户余额</h2>\r\n        </div>\r\n        <div className=\"balance-amount\">\r\n          <span className=\"currency\">积分</span>\r\n          <span className=\"amount\">{credits.toLocaleString()}</span>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"apikey-section card\">\r\n        <div className=\"section-header\">\r\n          <h2>APIKey 管理</h2>\r\n          <button onClick={() => setShowCreateModal(true)} className=\"btn-primary\">\r\n            创建新 Key\r\n          </button>\r\n        </div>\r\n\r\n        {apiKeys.length === 0 ? (\r\n          <p className=\"text-muted\">暂无 APIKey，点击上方按钮创建</p>\r\n        ) : (\r\n          <div className=\"apikey-list\">\r\n            {apiKeys.map((key: any) => (\r\n              <div key={key.id || key.key} className=\"apikey-item\">\r\n                <div className=\"key-info\">\r\n                  <strong>{key.name}</strong>\r\n                  <code>{key.key}</code>\r\n                </div>\r\n                <div className=\"key-stats\">\r\n                  <span>余额: {key.credits}</span>\r\n                  <span>到期: {key.expireTime ? new Date(key.expireTime * 1000).toLocaleDateString() : \"永久\"}</span>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"model-status-section card\">\r\n        <h2>模型状态监控</h2>\r\n        <div className=\"model-list\">\r\n          {Object.entries(modelStatuses).map(([model, status]) => (\r\n            <div key={model} className=\"model-item\">\r\n              <span className=\"model-name\">{model}</span>\r\n              <span className={`status-badge ${status.status ? \"online\" : \"offline\"}`}>\r\n                {status.status ? \"正常\" : \"异常\"}\r\n              </span>\r\n              {status.error && <span className=\"error-msg\">{status.error}</span>}\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      {showCreateModal && (\r\n        <CreateKeyModal\r\n          onClose={() => setShowCreateModal(false)}\r\n          onCreate={handleCreateKey}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction CreateKeyModal({\r\n  onClose,\r\n  onCreate,\r\n}: {\r\n  onClose: () => void;\r\n  onCreate: (data: any) => void;\r\n}) {\r\n  const [formData, setFormData] = useState({\r\n    name: \"\",\r\n    type: 0,\r\n    credits: 0,\r\n    expireTime: 0,\r\n  });\r\n\r\n  const handleSubmit = (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    onCreate(formData);\r\n  };\r\n\r\n  return (\r\n    <div className=\"modal-overlay\" onClick={onClose}>\r\n      <div className=\"modal-content\" onClick={(e) => e.stopPropagation()}>\r\n        <div className=\"modal-header\">\r\n          <h3>创建 APIKey</h3>\r\n          <button onClick={onClose} className=\"close-btn\">×</button>\r\n        </div>\r\n\r\n        <form onSubmit={handleSubmit} className=\"create-key-form\">\r\n          <div className=\"form-group\">\r\n            <label>Key 名称</label>\r\n            <input\r\n              type=\"text\"\r\n              value={formData.name}\r\n              onChange={(e) => setFormData({ ...formData, name: e.target.value })}\r\n              placeholder=\"例如: 生产环境 Key\"\r\n              required\r\n            />\r\n          </div>\r\n\r\n          <div className=\"form-group\">\r\n            <label>类型</label>\r\n            <select\r\n              value={formData.type}\r\n              onChange={(e) => setFormData({ ...formData, type: parseInt(e.target.value, 10) })}\r\n            >\r\n              <option value={0}>无限额度</option>\r\n              <option value={1}>限制额度</option>\r\n            </select>\r\n          </div>\r\n\r\n          {formData.type === 1 && (\r\n            <div className=\"form-group\">\r\n              <label>积分额度</label>\r\n              <input\r\n                type=\"number\"\r\n                value={formData.credits}\r\n                onChange={(e) => setFormData({ ...formData, credits: parseInt(e.target.value, 10) || 0 })}\r\n                placeholder=\"例如: 10000\"\r\n                min={0}\r\n              />\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"form-group\">\r\n            <label>到期时间（可选）</label>\r\n            <input\r\n              type=\"datetime-local\"\r\n              onChange={(e) => {\r\n                const timestamp = e.target.value ? Math.floor(new Date(e.target.value).getTime() / 1000) : 0;\r\n                setFormData({ ...formData, expireTime: timestamp });\r\n              }}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"modal-actions\">\r\n            <button type=\"button\" onClick={onClose} className=\"btn-secondary\">\r\n              取消\r\n            </button>\r\n            <button type=\"submit\" className=\"btn-primary\">\r\n              创建\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\admin\\AdminLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\admin\\BlogManagementPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadBlogs'. Either include it or remove the dependency array.","line":15,"column":6,"nodeType":"ArrayExpression","endLine":15,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [loadBlogs, page, search, statusFilter]","fix":{"range":[442,470],"text":"[loadBlogs, page, search, statusFilter]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadBlogs'. Either include it or remove the dependency array.","line":22,"column":6,"nodeType":"ArrayExpression","endLine":22,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [loadBlogs, page, search, statusFilter]","fix":{"range":[756,784],"text":"[loadBlogs, page, search, statusFilter]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\n\r\nexport default function BlogManagementPage() {\r\n  const [blogs, setBlogs] = useState<any[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [page, setPage] = useState(1);\r\n  const [total, setTotal] = useState(0);\r\n  const [search, setSearch] = useState(\"\");\r\n  const [statusFilter, setStatusFilter] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    loadBlogs();\r\n  }, [page, search, statusFilter]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    const handler = () => loadBlogs();\r\n    window.addEventListener(\"profile-updated\", handler as EventListener);\r\n    return () => window.removeEventListener(\"profile-updated\", handler as EventListener);\r\n  }, [page, search, statusFilter]);\r\n\r\n  const loadBlogs = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const token = localStorage.getItem(\"token\");\r\n      const params = new URLSearchParams({\r\n        page: page.toString(),\r\n        limit: \"20\",\r\n        ...(search ? { search } : {}),\r\n        ...(statusFilter ? { status: statusFilter } : {}),\r\n      });\r\n\r\n      const response = await fetch(`/api/admin/blogs?${params.toString()}`, {\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n      });\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setBlogs(data.blogs || []);\r\n        setTotal(data.total || 0);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to load blogs:\", error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (blogId: number, title: string) => {\r\n    if (!confirm(`确定要删除文章《${title}》吗？此操作不可恢复。`)) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const token = localStorage.getItem(\"token\");\r\n      const response = await fetch(`/api/admin/blogs/${blogId}`, {\r\n        method: \"DELETE\",\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n      });\r\n\r\n      if (response.ok) {\r\n        alert(\"文章删除成功\");\r\n        loadBlogs();\r\n      } else {\r\n        alert(\"删除失败\");\r\n      }\r\n    } catch (error: any) {\r\n      alert(`删除失败: ${error.message}`);\r\n    }\r\n  };\r\n\r\n  const handleStatusChange = async (blogId: number, newStatus: string) => {\r\n    try {\r\n      const token = localStorage.getItem(\"token\");\r\n      const response = await fetch(`/api/admin/blogs/${blogId}`, {\r\n        method: \"PUT\",\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({ status: newStatus }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        alert(\"状态更新成功\");\r\n        loadBlogs();\r\n      } else {\r\n        alert(\"更新失败\");\r\n      }\r\n    } catch (error: any) {\r\n      alert(`更新失败: ${error.message}`);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div>\r\n      <div className=\"page-header\">\r\n        <h1 className=\"page-title\">文章管理</h1>\r\n        <p className=\"page-subtitle\">管理所有用户文章</p>\r\n      </div>\r\n\r\n      <div className=\"admin-card\">\r\n        <div className=\"card-header\" style={{ flexWrap: \"wrap\", gap: \"1rem\" }}>\r\n          <input\r\n            type=\"text\"\r\n            placeholder=\"搜索文章...\"\r\n            value={search}\r\n            onChange={(e) => setSearch(e.target.value)}\r\n            className=\"admin-input\"\r\n            style={{ width: \"300px\" }}\r\n          />\r\n          <select\r\n            value={statusFilter}\r\n            onChange={(e) => setStatusFilter(e.target.value)}\r\n            className=\"admin-select\"\r\n          >\r\n            <option value=\"\">全部状态</option>\r\n            <option value=\"published\">已发布</option>\r\n            <option value=\"draft\">草稿</option>\r\n          </select>\r\n          <div style={{ marginLeft: \"auto\" }}>共 {total} 篇文章</div>\r\n        </div>\r\n\r\n        {loading ? null : (\r\n          <table className=\"admin-table\">\r\n            <thead>\r\n              <tr>\r\n                <th>标题</th>\r\n                <th>作者</th>\r\n                <th>状态</th>\r\n                <th>创建时间</th>\r\n                <th>操作</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {blogs.map((blog) => (\r\n                <tr key={blog.id}>\r\n                  <td><strong>{blog.title}</strong></td>\r\n                  <td>{blog.username}</td>\r\n                  <td>\r\n                    <span className={`badge badge-${blog.status === \"published\" ? \"success\" : \"warning\"}`}>\r\n                      {blog.status === \"published\" ? \"已发布\" : \"草稿\"}\r\n                    </span>\r\n                  </td>\r\n                  <td>{new Date(blog.created_at).toLocaleString(\"zh-CN\")}</td>\r\n                  <td>\r\n                    <div style={{ display: \"flex\", gap: \"0.5rem\" }}>\r\n                      {blog.status === \"draft\" && (\r\n                        <button\r\n                          onClick={() => handleStatusChange(blog.id, \"published\")}\r\n                          className=\"btn-admin btn-admin-primary\"\r\n                          style={{ padding: \"0.375rem 0.75rem\", fontSize: \"0.8125rem\" }}\r\n                        >\r\n                          发布\r\n                        </button>\r\n                      )}\r\n                      {blog.status === \"published\" && (\r\n                        <button\r\n                          onClick={() => handleStatusChange(blog.id, \"draft\")}\r\n                          className=\"btn-admin btn-admin-secondary\"\r\n                          style={{ padding: \"0.375rem 0.75rem\", fontSize: \"0.8125rem\" }}\r\n                        >\r\n                          撤回\r\n                        </button>\r\n                      )}\r\n                      <button\r\n                        onClick={() => handleDelete(blog.id, blog.title)}\r\n                        className=\"btn-admin btn-admin-danger\"\r\n                        style={{ padding: \"0.375rem 0.75rem\", fontSize: \"0.8125rem\" }}\r\n                      >\r\n                        删除\r\n                      </button>\r\n                    </div>\r\n                  </td>\r\n                </tr>\r\n              ))}\r\n            </tbody>\r\n          </table>\r\n        )}\r\n\r\n        {total > 20 && (\r\n          <div style={{ marginTop: \"1rem\", display: \"flex\", gap: \"0.5rem\", justifyContent: \"center\" }}>\r\n            <button\r\n              onClick={() => setPage((p) => Math.max(1, p - 1))}\r\n              disabled={page === 1}\r\n              className=\"btn-admin btn-admin-secondary\"\r\n            >\r\n              上一页\r\n            </button>\r\n            <span style={{ padding: \"0.5rem 1rem\" }}>第 {page} 页</span>\r\n            <button\r\n              onClick={() => setPage((p) => p + 1)}\r\n              disabled={page * 20 >= total}\r\n              className=\"btn-admin btn-admin-secondary\"\r\n            >\r\n              下一页\r\n            </button>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\admin\\DashboardPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\code\\witweb\\web\\src\\components\\legacy\\admin\\UserManagementPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadUsers'. Either include it or remove the dependency array.","line":14,"column":6,"nodeType":"ArrayExpression","endLine":14,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [loadUsers, page, search]","fix":{"range":[385,399],"text":"[loadUsers, page, search]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadUsers'. Either include it or remove the dependency array.","line":21,"column":6,"nodeType":"ArrayExpression","endLine":21,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [loadUsers, page, search]","fix":{"range":[685,699],"text":"[loadUsers, page, search]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\n\r\nexport default function UserManagementPage() {\r\n  const [users, setUsers] = useState<any[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [page, setPage] = useState(1);\r\n  const [total, setTotal] = useState(0);\r\n  const [search, setSearch] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    loadUsers();\r\n  }, [page, search]);\r\n\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    const handler = () => loadUsers();\r\n    window.addEventListener(\"profile-updated\", handler as EventListener);\r\n    return () => window.removeEventListener(\"profile-updated\", handler as EventListener);\r\n  }, [page, search]);\r\n\r\n  const loadUsers = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const token = localStorage.getItem(\"token\");\r\n      const params = new URLSearchParams({\r\n        page: page.toString(),\r\n        limit: \"20\",\r\n        ...(search ? { search } : {}),\r\n      });\r\n\r\n      const response = await fetch(`/api/admin/users?${params.toString()}`, {\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n      });\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setUsers(data.users || []);\r\n        setTotal(data.total || 0);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Failed to load users:\", error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (username: string) => {\r\n    if (!confirm(`确定要删除用户 ${username} 吗？此操作不可恢复。`)) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const token = localStorage.getItem(\"token\");\r\n      const response = await fetch(`/api/admin/users/${username}`, {\r\n        method: \"DELETE\",\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n      });\r\n\r\n      if (response.ok) {\r\n        alert(\"用户删除成功\");\r\n        loadUsers();\r\n      } else {\r\n        alert(\"删除失败\");\r\n      }\r\n    } catch (error: any) {\r\n      alert(`删除失败: ${error.message}`);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div>\r\n      <div className=\"page-header\">\r\n        <h1 className=\"page-title\">用户管理</h1>\r\n        <p className=\"page-subtitle\">管理所有注册用户</p>\r\n      </div>\r\n\r\n      <div className=\"admin-card\">\r\n        <div className=\"card-header\">\r\n          <input\r\n            type=\"text\"\r\n            placeholder=\"搜索用户...\"\r\n            value={search}\r\n            onChange={(e) => setSearch(e.target.value)}\r\n            className=\"admin-input\"\r\n            style={{ width: \"300px\" }}\r\n          />\r\n          <div>共 {total} 个用户</div>\r\n        </div>\r\n\r\n        {loading ? null : (\r\n          <table className=\"admin-table\">\r\n            <thead>\r\n              <tr>\r\n                <th>用户名</th>\r\n                <th>注册时间</th>\r\n                <th>状态</th>\r\n                <th>操作</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {users.map((user) => (\r\n                <tr key={user.username}>\r\n                  <td><strong>{user.username}</strong></td>\r\n                  <td>{new Date(user.created_at).toLocaleString(\"zh-CN\")}</td>\r\n                  <td>\r\n                    <span className={`badge badge-${user.status === \"active\" ? \"success\" : \"warning\"}`}>\r\n                      {user.status || \"active\"}\r\n                    </span>\r\n                  </td>\r\n                  <td>\r\n                    {user.username !== \"witw\" && (\r\n                      <button\r\n                        onClick={() => handleDelete(user.username)}\r\n                        className=\"btn-admin btn-admin-danger\"\r\n                        style={{ padding: \"0.375rem 0.75rem\", fontSize: \"0.8125rem\" }}\r\n                      >\r\n                        删除\r\n                      </button>\r\n                    )}\r\n                  </td>\r\n                </tr>\r\n              ))}\r\n            </tbody>\r\n          </table>\r\n        )}\r\n\r\n        {total > 20 && (\r\n          <div style={{ marginTop: \"1rem\", display: \"flex\", gap: \"0.5rem\", justifyContent: \"center\" }}>\r\n            <button\r\n              onClick={() => setPage((p) => Math.max(1, p - 1))}\r\n              disabled={page === 1}\r\n              className=\"btn-admin btn-admin-secondary\"\r\n            >\r\n              上一页\r\n            </button>\r\n            <span style={{ padding: \"0.5rem 1rem\" }}>第 {page} 页</span>\r\n            <button\r\n              onClick={() => setPage((p) => p + 1)}\r\n              disabled={page * 20 >= total}\r\n              className=\"btn-admin btn-admin-secondary\"\r\n            >\r\n              下一页\r\n            </button>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]}]