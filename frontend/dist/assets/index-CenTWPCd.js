(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const f of o.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&r(f)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();lucide.createIcons();let g=null,E=null,P="upload",m=null,u=null,l=[],p="",_="",B=!1;const s=e=>{const t=document.getElementById("log");if(!t){console.log(e);return}const n=new Date().toLocaleTimeString();t.textContent+=`[${n}] ${e}
`,t.scrollTop=t.scrollHeight},c=e=>document.getElementById(e).value.trim();function i(){const e={hostMode:document.getElementById("hostMode").value,charMode:P,charUrl:document.getElementById("charUrl").value,charPid:document.getElementById("charPid").value,charTimestamps:document.getElementById("charTimestamps").value,charWebHook:document.getElementById("charWebHook").value,charShutProgress:document.getElementById("charShutProgress").value,characterRef:document.getElementById("characterRef").value,prompt:document.getElementById("prompt").value};localStorage.setItem("sora2_settings",JSON.stringify(e))}function U(){const e=localStorage.getItem("sora2_settings");if(e)try{const t=JSON.parse(e);t.hostMode&&(document.getElementById("hostMode").value=t.hostMode),v(t.hostMode||"auto"),t.charMode&&H(t.charMode),t.charUrl!==void 0&&(document.getElementById("charUrl").value=t.charUrl),t.charPid!==void 0&&(document.getElementById("charPid").value=t.charPid),t.charTimestamps!==void 0&&(document.getElementById("charTimestamps").value=t.charTimestamps),t.charWebHook!==void 0&&(document.getElementById("charWebHook").value=t.charWebHook),t.charShutProgress!==void 0&&(document.getElementById("charShutProgress").value=t.charShutProgress),t.characterRef!==void 0&&(document.getElementById("characterRef").value=t.characterRef),t.prompt!==void 0&&(document.getElementById("prompt").value=t.prompt)}catch{}}function v(e){const t={auto:"自动",domestic:"国内",overseas:"海外"},n=document.getElementById("hostBadge");n&&(n.textContent=t[e]||"自动")}function q(e){if(e==null)return"-";const t=Number(e);return Number.isNaN(t)?"-":t.toLocaleString("zh-CN")}function A(e){if(e==null)return"-";const t=Math.max(0,Number(e));if(Number.isNaN(t))return"-";if(t<60)return`${t}s`;const n=Math.floor(t/60),r=t%60;return`${n}m ${r}s`}function T(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}let d=[];function C(e){const t=(e||"").replace(/[,，]/g," ").trim();if(!t)return[];const n=t.split(/\s+/).filter(Boolean).map(r=>r.replace(/^@/,""));return Array.from(new Set(n))}function S(e){localStorage.setItem("sora2_recent_refs",JSON.stringify(e||[]))}function K(){const e=localStorage.getItem("sora2_recent_refs");if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function y(){const e=document.getElementById("characterRefList");if(e){if(!d.length){e.innerHTML="";return}e.innerHTML=d.map(t=>`<span class="ref-chip" onclick="insertCharacterRefToPrompt('${t}')">@${t}<span class="ref-del" onclick="removeRecentRef(event, '${t}')">×</span></span>`).join("")}}function G(e){if(!e)return;const t=document.getElementById("prompt");if(!t)return;const n=`@${e}`,r=t.selectionStart??t.value.length,a=t.selectionEnd??t.value.length,o=t.value.slice(0,r),f=t.value.slice(a),N=o&&!/\s$/.test(o)?" ":"",O=f&&!/^\s/.test(f)?" ":"";t.value=`${o}${N}${n}${O}${f}`;const M=(o+N+n+O).length;t.focus(),t.selectionStart=M,t.selectionEnd=M,i()}function Q(e,t){e&&e.stopPropagation(),d=d.filter(n=>n!==t),y(),S(d),j(d)}async function j(e){try{await fetch("/config/query-defaults",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:{character_refs:e}})})}catch{}}function $(e){if(!e.length)return;const t=[...e,...d.filter(n=>!e.includes(n))].slice(0,8);d=t,y(),S(t),j(t)}function H(e){P=e,document.getElementById("charModeUpload").style.display=e==="upload"?"block":"none",document.getElementById("charModePid").style.display=e==="pid"?"block":"none",document.getElementById("tabUpload").style.background=e==="upload"?"var(--card)":"transparent",document.getElementById("tabPid").style.background=e==="pid"?"var(--card)":"transparent",i()}function R(e){const t=document.getElementById("characterStatus"),n={succeeded:"成功",failed:"失败",running:"处理中"};t.textContent=n[e]||"等待中"}function x(e){const t=document.getElementById("characterProgress");t.textContent=e==null?"-":`${e}%`}function L(e){const t=document.getElementById("characterFailure");t.textContent=e||"-"}function k(e){document.getElementById("characterId").textContent=e||"-"}function X(e){if(!e||typeof e!="object")return"";const t=e.character_id||e.characterId;if(t)return String(t);const n=e.results;return Array.isArray(n)&&n.length?String(n[0].character_id||n[0].characterId||""):n&&typeof n=="object"?String(n.character_id||n.characterId||""):""}function z(e){return e==="true"?!0:e==="false"?!1:null}function Y(){P==="upload"?re():ae()}function D(){const e=C(c("characterRef"));if(e!==null){if(!e.length){s("提示：请输入角色 ID");return}$(e),s(`已保存角色 ID：${e.map(t=>`@${t}`).join(" ")}`)}}function I(){const e=document.getElementById("activeTasks");if(!l.length){e.innerHTML='<div class="monitor-placeholder" style="font-size:11px">暂无任务</div>';return}e.innerHTML=l.map(t=>{const n=t.status||"排队中",r=A(Math.floor((Date.now()-t.startTime)/1e3));return`<div class="active-item">
      <div class="active-title">${T(t.prompt||"")}</div>
      <div class="active-meta">
        <span>状态: ${n}</span>
        <span>进度: ${t.progress||0}%</span>
        <span>已用: ${r}</span>
      </div>
      <div class="active-progress">
        <div class="active-bar"><div style="width:${t.progress||0}%"></div></div>
        <div class="active-meta" style="margin-top:6px">
          <span>进度条</span>
          <button class="btn btn-ghost" style="padding:2px 6px; font-size:10px" onclick="cancelActiveTask('${t.id}')">取消</button>
        </div>
      </div>
    </div>`}).join("")}function Z(e,t,n){l.some(r=>r.id===e)||(l.push({id:e,prompt:t||"",startTime:n||Date.now(),status:"排队中",progress:0,finalizing:!1}),I(),F())}async function b(e){l=l.filter(t=>t.id!==e),I();try{await fetch("/tasks/active/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e})})}catch{}}function ee(e){e&&(b(e),s("已从队列移除任务（不影响后端实际执行）"))}async function J(){try{const t=await(await fetch("/tasks/active")).json();Array.isArray(t)&&(l=t.map(n=>({id:n.id,prompt:n.prompt||"",startTime:n.start_time?n.start_time*1e3:Date.now(),status:"排队中",progress:0,finalizing:!1})),I(),F())}catch{}}function F(){g||(g=setInterval(te,3e3))}async function te(){if(!l.length){clearInterval(g),g=null;return}await Promise.all(l.map(async e=>{if(!e.finalizing)try{const n=await(await fetch("/result",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id})})).json();e.status=n.status||"running",e.progress=n.progress||0,e.status==="succeeded"?(e.finalizing=!0,await(await fetch("/generate/finalize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id,prompt:e.prompt})})).json(),w(),h(),b(e.id)):e.status==="failed"&&(s("失败："+(n.error||n.failure_reason||"未知异常")),b(e.id))}catch{}})),I()}async function ne(){var r;const e=c("prompt");if(!e){s("提示：提示词不能为空");return}const t={prompt:e,duration:parseInt(c("duration"),10),aspectRatio:c("aspectRatio"),size:c("size"),url:((r=document.getElementById("refImagePreview"))==null?void 0:r.src)||""},n=C(c("characterRef"));if(n!==null){if(n.length){const a=n.filter(o=>!t.prompt.includes(`@${o}`)).map(o=>`@${o}`).join(" ");a&&(t.prompt=`${a} ${t.prompt}`),$(n)}s("指令：开始提交渲染任务...");try{E=(await(await fetch("/generate/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()).id,s(`系统：任务已创建 [ID: ${E}]`),Z(E,e,Date.now())}catch(a){s("错误："+a.message)}}}async function re(){const e=c("charTimestamps")||"0,3";i();const t={timestamps:e,webHook:c("charWebHook")||"-1"},n=c("charUrl");if(n)t.url=n;else if(p)t.url=p;else{s("错误：请提供素材链接或选择本地视频");return}const r=z(c("charShutProgress"));if(r!==null&&(t.shutProgress=r),R("running"),x(0),L(""),k(""),m=(await(await fetch("/character/upload/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()).id,!m){s("错误：角色任务创建失败");return}u&&clearInterval(u),u=setInterval(V,3e3)}async function ae(){const e=c("charPid"),t=c("charTimestamps")||"0,3";if(!e){s("错误：请输入 PID");return}i();const n={pid:e,timestamps:t,webHook:c("charWebHook")||"-1"},r=z(c("charShutProgress"));if(r!==null&&(n.shutProgress=r),R("running"),x(0),L(""),k(""),m=(await(await fetch("/character/create/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json()).id,!m){s("错误：角色任务创建失败");return}u&&clearInterval(u),u=setInterval(V,3e3)}async function V(){if(!m)return;const t=await(await fetch("/result",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:m})})).json(),n=t.status||"running",r=t.progress||0,a=X(t),o=t.failure_reason||t.error||"";R(n),x(r),L(o),a&&k(a),n!==_&&(s(`角色任务状态: ${n} (${r}%)`),_=n),n==="succeeded"&&!B&&(s(`角色任务完成响应: ${JSON.stringify(t)}`),B=!0),n==="succeeded"&&!a&&s("警告：任务成功但未返回角色 ID"),(n==="succeeded"||n==="failed")&&(clearInterval(u),u=null,B=!1)}function oe(){const e=document.getElementById("characterId").textContent.trim();!e||e==="-"||(navigator.clipboard.writeText(e),s("角色 ID 已复制"))}async function w(){try{const t=await(await fetch("/videos")).json(),n=document.getElementById("localVideoList");n.innerHTML=t.reverse().map(r=>`
      <div class="video-card">
        <video class="video-thumb" src="${r.url}" muted onmouseover="this.play()" onmouseout="this.pause()"></video>
        <div class="v-title" style="font-size:12px; font-weight:bold; margin-bottom:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${r.name}</div>
        <div class="v-meta">
          <span>${(r.size/1024/1024).toFixed(1)}MB</span>
          <span>${se(r.generated_time)}</span>
          <span>${A(r.duration_seconds)}</span>
          <span>悬停预览</span>
        </div>
        <div class="v-prompt" title="${T(r.prompt||"")}">${T(r.prompt||"")}</div>
        <div class="btn-row" style="margin-top:8px">
          <a class="btn btn-ghost" style="padding:2px 6px; font-size:10px; text-decoration:none" href="${r.url}" target="_blank">打开</a>
          <a class="btn btn-ghost" style="padding:2px 6px; font-size:10px; text-decoration:none" href="${r.url}" download>下载</a>
          <button class="btn btn-ghost" style="padding:2px 6px; font-size:10px" onclick="deleteVideo('${r.name}')">删除</button>
        </div>
      </div>
    `).join("")}catch{}}function se(e){return e?new Date(e*1e3).toLocaleString():"-"}function ce(){const e=document.getElementById("refImageFile");e&&(e.value="");const t=document.getElementById("refImagePreviewWrap"),n=document.getElementById("refImagePreview");n&&(n.src=""),t&&(t.style.display="none")}function ie(){const e=document.getElementById("charFile");e&&(e.value=""),p="";const t=document.getElementById("charVideoPreviewWrap"),n=document.getElementById("charVideoPreview");n&&(n.pause(),n.removeAttribute("src"),n.load()),t&&(t.style.display="none")}async function de(e){!e||!confirm("确认删除该视频吗？")||(await fetch("/videos/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e})}),w())}document.getElementById("refImageFile").addEventListener("change",e=>{const t=e.target.files[0];if(t){const n=new FileReader;n.onload=()=>{const r=document.getElementById("refImagePreviewWrap"),a=document.getElementById("refImagePreview");a&&(a.src=n.result),r&&(r.style.display="block"),s("系统：本地参考图已加载")},n.readAsDataURL(t)}else{const n=document.getElementById("refImagePreviewWrap"),r=document.getElementById("refImagePreview");r&&(r.src=""),n&&(n.style.display="none")}});document.getElementById("charFile").addEventListener("change",e=>{const t=e.target.files[0];if(!t){p="";const r=document.getElementById("charVideoPreviewWrap"),a=document.getElementById("charVideoPreview");a&&(a.pause(),a.removeAttribute("src"),a.load()),r&&(r.style.display="none");return}const n=new FileReader;n.onload=()=>{p=n.result;const r=document.getElementById("charVideoPreviewWrap"),a=document.getElementById("charVideoPreview");a&&(a.src=n.result,a.load()),r&&(r.style.display="block"),s("系统：本地角色视频已加载")},n.readAsDataURL(t)});async function W(){const e=c("hostMode");i(),await fetch("/config/host-mode",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host_mode:e})}),v(e),s(`系统：节点切换至 ${e}`)}async function h(){const e=document.getElementById("accountCredits");e.textContent="查询中...",e.className="credit-empty";try{const n=await(await fetch("/credits")).json();if(n.error){e.textContent=n.error==="missing token"?"未配置":"错误",e.className="credit-empty";return}const r=n.credits??null;e.textContent=q(r),r===null?e.className="credit-empty":Number(r)<=0?e.className="credit-low":e.className="credit-ok"}catch{e.textContent="错误",e.className="credit-low"}}window.onload=()=>{U(),d=K(),y(),w(),h(),J(),s("系统：日志已启动");const e=document.getElementById("addCharacterRefBtn");e&&e.addEventListener("click",()=>{D()}),fetch("/config").then(t=>t.json()).then(t=>{t.host_mode&&(document.getElementById("hostMode").value=t.host_mode),t.host_mode&&v(t.host_mode);const n=t.query_defaults&&Array.isArray(t.query_defaults.character_refs)?t.query_defaults.character_refs:[],r=[...d,...n.filter(a=>!d.includes(a))].slice(0,8);d=r,y(),S(r),h()}),setInterval(h,3e4)};document.getElementById("hostMode").addEventListener("change",()=>{i(),v(c("hostMode")),W()});document.getElementById("charUrl").addEventListener("change",i);document.getElementById("charPid").addEventListener("change",i);document.getElementById("charTimestamps").addEventListener("change",i);document.getElementById("charWebHook").addEventListener("change",i);document.getElementById("charShutProgress").addEventListener("change",i);document.getElementById("prompt").addEventListener("input",i);document.getElementById("characterRef").addEventListener("change",()=>{const e=C(c("characterRef"));e!==null&&(i(),$(e))});lucide.createIcons();window.setHostMode=W;window.gen=ne;window.refreshActiveTasks=J;window.loadLocalVideos=w;window.switchCharMode=H;window.executeCharAction=Y;window.copyCharacterId=oe;window.clearRefImage=ce;window.clearCharVideo=ie;window.deleteVideo=de;window.addCharacterRefFromInput=D;window.insertCharacterRefToPrompt=G;window.removeRecentRef=Q;window.cancelActiveTask=ee;
